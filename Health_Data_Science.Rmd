---
title: Health Data Science
output:
  html_document:
    fig_caption: yes
    theme: flatly #sandstone #spacelab #flatly
    highlight: pygments
    code_folding: show
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      smooth_scroll: FALSE
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Only need to run these once:
#  install.packages("foreign")  
#  install.packages("tidyverse")
#  install.packages("readr")
#  install.packages("readxl")
#  install.packages("haven")
#  install.packages("survey")
#  install.packages("remotes")


# Run these every time you re-start R:
  library(foreign)
  library(tidyverse)
  library(readr)
  library(readxl)
  library(haven)
  library(survey)
  library(remotes)
#  library(MEPS)
```

# 1 - First Paragraph

**For the project i offer to consider the following topic: 'Young Adults Aged 18-24 Who Had Ever Used an Electronic Nicotine have poor general health and more likely to have asthma diagnoses'**

Comment by Giuseppe:

(I think this topic is too specific and the dataset will not allow us to explore it deeply.
We would need to have information on older persons that have asthma and their smoking habits when they were young)

I propose we chose a more general topic:

<hr>

**The central question we want to answer is: what are the negative effects of smoking?**

We will look at the association between smoking and health related issues. We 
will also look at some mental health indicators and how they relate to smoking
habits.

<hr>


*Here is info about characteristics:* <https://meps.ahrq.gov/data_files/publications/st554/stat554.shtml>

*Here is questionary report:* <https://meps.ahrq.gov/survey_comp/hc_survey/paper_quest/2021/2021_SHE_SAQ.pdf>

*Codebook:* <https://meps.ahrq.gov/data_stats/download_data/pufs/h233/h233cb.pdf>


```{r}
# the dataset is in the github repo, we don't need to download it every time
h233 <- read_dta("h233.dta")
head(h233)
```

Our main explanatory variables:

ADSMOK42: currently smokes

ADNSMK42 - If ADSMOK42 = 1, doctor advised you to quit smoking

SDENICPROD: used electronic nicotine product

ADDPRS42: felt down/depressed

ADGENH42: health in general

ADENGY42: had a lot of energy

ADHOPE42: how often felt hopeless

ADNERV42: how often felt nervous

ADPCFL42: felt calm/peaceful

ADSAD42: how often felt sad

AGELAST: person age

ASTHDX: asthma diagnosis

ARTHDX:  had ever been diagnosed with arthritis

CALUNG: lung cancer diagnosed

CHOLDX: high cholesterol diagnosis

CHBRON31: if the person (aged 18 or older) has had chronic bronchitis in the last 12 months

DIABDX_M18: diabetes diagnosis

EMPHDX: Emphysema diagnosis

EMPST31: employment status

FAMINC21: family income

HIBPDX: whether the person had ever been diagnosed as having high blood pressure (other than during pregnancy)

MNHLTH31: perceived mental health status

MARRY21X: marital status

TTLP21X: person total income

OHRTDX: asked if the person had ever been diagnosed with any other kind of heart disease or condition

OHRTTYPE: specify other heart diseases or conditions

RTHLTH31: perceived health status

REGION21:indicate the Census region for the RU. (A Reporting Unit (RU) is a person or group of persons in the sampled DU who are related by blood, marriage, adoption, or other family association. Each RU was interviewed as a single entity for MEPS.)

WLKLIM53: limitation in physical functioning

SDCOMPAN: feel lack of companionship

STRKDX: asked if the person (aged 18 or older) had ever been diagnosed as having had a stroke or transient ischemic attack 

SDLEFTOUT: feel left out

SDLIFE: satisfied with life

SDHOME - How satisfied with house/apartment where person lives

SDISOL - How often feel isolated from others

SEX: gender

SDMEDCARE - Rate neighborhood availability of places to get medical care

SDHLTHFOOD - Rate neighborhood availability of places to buy healthy food

SDHMDEPR - When under 18 years of age, lived with someone who was depressed, mentally ill, or suicidal

SDHMALC - When under 18 years of age, lived with a problem drinker or alcoholic

SDHMDRG - When under 18 years of age, lived with someone who used illegal street drugs or abused prescription medication

SDHMDIV - Parents separated or divorced

SDHMBEAT - How often did parents or adults in home slap, hit, kick, punch, or beat each other up

SDHURTCHLD - How often did parents or adults in home hit, beat, kick, or physically hurt person

FTSTU21X: student status

RACEV2X:race


## 46 variables 
#Variables of interest: ADSMOK42, ADNSMK42, SDENICPROD

#Demograpfical variables: AGELAST, REGION21, SEX, RACEV2X, MARRY21X, FTSTU21X, TTLP21X, FAMINC21, EMPST31

#Mental health: ADDPRS42, ADHOPE42, ADNERV42, ADPCFL42, ADSAD42, MNHLTH31

#General health: ADGENH42, ADENGY42, RTHLTH31, WLKLIM53

#Health deseases: ASTHDX, ARTHDX, CALUNG, CHOLDX, CHBRON31, DIABDX_M18, EMPHDX, HIBPDX, OHRTDX, OHRTTYPE, STRKDX

#The Social Determinants of Health Survey (SDOH) includes questions about the social determinants of health, such as housing, financial well-being, food security, social support, discrimination, and physical and sexual violence.: SDLIFE, SDHOME, SDMEDCARE, SDHLTHFOOD, SDCOMPAN, SDLEFTOUT, SDISOL, SDHMDEPR, SDHMALC, SDHMDRG, SDHMDIV, SDHMBEAT, SDHURTCHLD

```{r}
vars_to_keep = c("ADSMOK42","SDENICPROD","ADDPRS42","ADGENH42",
                 "ADENGY42","ADHOPE42","ADNERV42","ADPCFL42","ADSAD42",
                 "AGELAST","ASTHDX","CALUNG","CHOLDX","DIABDX_M18","EMPHDX",
                 "FAMINC21","HIBPDX","MNHLTH31","RTHLTH31","TTLP21X",
                 "WLKLIM53","SDCOMPAN","SDLEFTOUT","SDLIFE", 'REGION21', 'RACEV2X', 
                 'FTSTU21X', 'SEX','STRKDX','HIBPDX', 'MARRY21X','CHBRON31' ,'CANCERDX', 
                 'ARTHDX', 'ADNSMK42', 'SDHOME', 'SDMEDCARE','SDHLTHFOOD', 'SDISOL',
                 'SDHMDEPR','SDHMALC','SDHMDRG', 'SDHMDIV', 'SDHMBEAT', 'SDHURTCHLD', 'EMPST31')

small_df = h233 %>% select(all_of(vars_to_keep)) %>% as_factor()
#turning the variables into factors

small_df = small_df %>% mutate(age_group = cut(AGELAST,
                                    breaks = c(-Inf,18, 25, 35, 45, 65, Inf),
                  labels = c("0-18","18-24", "25-34", "35-44", "45-64", "65+"),
                  right = FALSE))
#adding a new variable to break into age groups

small_df %>% summary()

```


# Descriptive statistics

ADSMOK42 is the code about the people that are currently smoking. 
ADNSMK42 is the code ADSMOK42 = 1, doctor advised you to quit smoking

#Descriptive graphs 

```{r}

# I tried to recreate the previous graph but adding more information -Giuseppe
small_df %>% select(ADSMOK42, age_group) %>% group_by(age_group) %>%
  summarise(n_smokers = sum(ADSMOK42 == "1 YES"),
            n_non_smokers = sum(ADSMOK42 == "2 NO"),
            n_inapplicable = sum(ADSMOK42 == "-1 INAPPLICABLE")) %>%
  mutate(perc_smokers = 100*n_smokers/n_non_smokers) %>% 
  slice(-1) %>%
  ggplot(aes(x = age_group)) +
  geom_col(aes(y = n_non_smokers, fill = "non smokers")) +
  geom_col(aes(y = n_smokers, fill = "smokers")) +
  geom_text(aes(label=paste(round(perc_smokers,2),"%"), y = n_smokers)) +
  labs(title = "Age distribution of smokers and non smokers",
       y = "count", x = "age group", fill = "") + theme_classic()

# e-smokers 
small_df %>% select(SDENICPROD, age_group) %>% group_by(age_group) %>%
  summarise(n_smokers = sum(SDENICPROD == "1 YES"),
            n_non_smokers = sum(SDENICPROD == "2 NO"),
            n_inapplicable = sum(SDENICPROD == "-1 INAPPLICABLE")) %>%
  mutate(perc_smokers = 100*n_smokers/n_non_smokers) %>% 
  slice(-1) %>%
  ggplot(aes(x = age_group)) +
  geom_col(aes(y = n_non_smokers, fill = "non e-cigarets smokers")) +
  geom_col(aes(y = n_smokers, fill = "e-cigarets smokers")) +
  geom_text(aes(label=paste(round(perc_smokers,2),"%"), y = n_smokers)) +
  labs(title = "Age distribution of e-sigarets smokers and non smokers",
       y = "count", x = "age group", fill = "") + theme_classic()

```
#Working on the demograpthical characteristics 

#For smokers 
```{r}
small_df <- small_df %>%
  mutate(
    sex_group = case_when(
      SEX == '1 MALE' ~ 'MALE',
      SEX == '2 FEMALE' ~ 'FEMALE',
      TRUE ~ NA_character_
    )
  )
smokers_df <- small_df %>% filter(ADSMOK42 == "1 YES")

non_smokers_df <- small_df %>% filter(ADSMOK42 == "2 NO")

e_smokers_df <-small_df %>% filter(SDENICPROD == "1 YES")

```

#Demograpthic characteristics 
##Difference between smokers and non-smokers 

```{r}

create_plots_demogr <- function(data, demographic_variables, titles) {
  data <- data %>%
    mutate(
      tot_inc_group = cut(TTLP21X,
                          breaks = c(-Inf, 10000, 15000, 20000, 25000, 30000, Inf),
                          labels = c("0-10000", "10001-15000", "15001-20000", "20001-25000", "25001-30000", "30000+"),
                          right = FALSE),
      fam_inc_group = cut(FAMINC21,
                          breaks = c(-Inf, 10000, 15000, 20000, 25000, 30000, Inf),
                          labels = c("0-10000", "10001-15000", "15001-20000", "20001-25000", "25001-30000", "30000+"),
                          right = FALSE)
    ) %>%
    filter(!is.na(tot_inc_group) & !is.na(fam_inc_group) & !is.na(sex_group)) %>%
    filter(tot_inc_group != "NA")
  
  create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in demographic_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

demographic_variables <- c("age_group", "REGION21", "sex_group", "RACEV2X", "MARRY21X", "FTSTU21X", "tot_inc_group", "fam_inc_group", "EMPST31")

titles_smokers <- c(
  age_group = "Age Group Distribution (Smokers)",
  REGION21 = "Region Distribution (Smokers)",
  sex_group = "Gender Distribution (Smokers)",
  RACEV2X = "Race Distribution (Smokers)",
  MARRY21X = "Marital Status Distribution (Smokers)",
  FTSTU21X = "Full-Time Student Distribution (Smokers)",
  tot_inc_group = "Total Income Distribution (Smokers)",
  fam_inc_group = "Family Income Distribution (Smokers)",
  EMPST31 = "Employment Status Distribution (Smokers)"
)

titles_non_smokers <- c(
  age_group = "Age Group Distribution (Non-Smokers)",
  REGION21 = "Region Distribution (Non-Smokers)",
  sex_group = "Gender Distribution (Non-Smokers)",
  RACEV2X = "Race Distribution (Non-Smokers)",
  MARRY21X = "Marital Status Distribution (Non-Smokers)",
  FTSTU21X = "Full-Time Student Distribution (Non-Smokers)",
  tot_inc_group = "Total Income Distribution (Non-Smokers)",
  fam_inc_group = "Family Income Distribution (Non-Smokers)",
  EMPST31 = "Employment Status Distribution (Non-Smokers)"
)


create_plots_demogr(smokers_df, demographic_variables, titles_smokers)

create_plots_demogr(non_smokers_df, demographic_variables, titles_non_smokers)

```
**Highlights**
*A collective image of smokers:*
* 40% are 45-64 y.o.
* 44% living in South region, ~22% in Midwest and ~22% in West
* 49% of male and 51% of female
* 70% of white race and 22% of black
* 32% never married, 31% married, just 21% divorced and 10% widowed
* 4% not a students, 1% full-time student, 0,31% part-time students
* Mean of total income is 30586, ~51% earn 30000+, ~25% earn less than 10000
* Mean of total income of family is 50665, 55% earn 30000+, other family's income distributed gradually in income range
* 50% are not employed during RD, 46% employed

*A collective image of non-smokers:*
* 36% are 65+ y.o., 31% are 45-64 y.o.
* 37% living in South region, 22% in Midwest and ~26% in West
* 56% of male and 44% of female
* 79% of white race and 11% of black
* 24% never married, 50% married, just 14% divorced and 10% widowed
* 4% not a students, 2,6 % full-time student, 0,04% part-time students
* Mean of total income is 47740, ~55% earn 30000+
* Mean of total income of family is 85484 , 44% earn 30000+,other family's income distributed gradually in income range
* 45% are not employed during RD, 53% employed

The distribution through smoker, who smokes because of doctor recommendation 
```{r}
ggplot(smokers_df, aes(x = ADNSMK42)) +
  geom_bar(fill = "skyblue") +
  labs(title = "Distribution of Smokers by Doctor's Recommendation", x = "Doctor's Recommendation", y = "Frequency") + theme_classic()
```
*The 38% of currently smokers smokes because of doctor advise to quit smoke*

The distribution of e-smokers in full data and through smokers
```{r}
ggplot(smokers_df, aes(x = SDENICPROD == "1 YES")) +
  geom_bar(fill = "lightcoral") +
  labs(title = "Distribution of e-Smokers through currently smokers", x = "E-smokers No/Yes", y = "Frequency") + theme_classic()
```
*Trough currently smokers just 21% are e-sigarets smokers*

```{r}
#mental health
create_plots_mental_health <- function(data, mental_health_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
 create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in mental_health_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

mental_health_variables <- c("ADDPRS42", "ADHOPE42", "ADNERV42", "ADPCFL42", "ADSAD42", "MNHLTH31")


titles_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (Smokers)",
  ADHOPE42 = "Hopefulness (Smokers)",
  ADNERV42 = "Nervousness (Smokers)",
  ADPCFL42 = "Psychological Fatigue (Smokers)",
  ADSAD42 = "Sadness (Smokers)",
  MNHLTH31 = "Mental Health Status (Smokers)"
)

titles_non_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (Non-Smokers)",
  ADHOPE42 = "Hopefulness (Non-Smokers)",
  ADNERV42 = "Nervousness (Non-Smokers)",
  ADPCFL42 = "Psychological Fatigue (Non-Smokers)",
  ADSAD42 = "Sadness (Non-Smokers)",
  MNHLTH31 = "Mental Health Status (Non-Smokers)"
)

titles_e_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (E-Smokers)",
  ADHOPE42 = "Hopefulness (E-Smokers)",
  ADNERV42 = "Nervousness (E-Smokers)",
  ADPCFL42 = "Psychological Fatigue (E-Smokers)",
  ADSAD42 = "Sadness (E-Smokers)",
  MNHLTH31 = "Mental Health Status (E-Smokers)"
)
create_plots_mental_health(smokers_df, mental_health_variables, titles_smokers_mental_health)
create_plots_mental_health(non_smokers_df, mental_health_variables, titles_non_smokers_mental_health)
create_plots_mental_health(e_smokers_df, mental_health_variables, titles_e_smokers_mental_health)
```
*Highlights*

* Mostly smokers don't perceived stress, hopefulness and sadness, nervousness mostly also no, but 25% little of the time. 36% of smokers little of the time have psychological fatigue. 35% smokers have a goog mental health, 24% very good mental health, 21% excellent and just 14% fair.

*In comparison, non-smokers mostly don't feel perceived stress, hopefulness and sadness. However, that mental health status is better: 40% have very good, 28% excellent and 28% good, just 7% fair.

*Another picture for e-smokers: mostly of them don't have perceived stress and hopefulness, but 24% fill little of time nervous and 15% some of the time. 27% little of the time have psychological fatigue, ~16% have it most of the time. Overall, 14% feel fair, mental health is more than less good or excellent. 


```{r}
create_plots_general_health <- function(data, general_health_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 2)) 
  for (variable in general_health_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

general_health_variables <- c("ADGENH42", "ADENGY42", "RTHLTH31", "WLKLIM53")


titles_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (Smokers)",
  ADENGY42 = "Energy Level (Smokers)",
  RTHLTH31 = "Overall Health Rating (Smokers)",
  WLKLIM53 = "Walking Limitation (Smokers)"
)

titles_non_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (Non-Smokers)",
  ADENGY42 = "Energy Level (Non-Smokers)",
  RTHLTH31 = "Overall Health Rating (Non-Smokers)",
  WLKLIM53 = "Walking Limitation (Non-Smokers)"
)

titles_e_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (E-Smokers)",
  ADENGY42 = "Energy Level (E-Smokers)",
  RTHLTH31 = "Overall Health Rating (E-Smokers)",
  WLKLIM53 = "Walking Limitation (E-Smokers)"
)


create_plots_general_health(smokers_df, general_health_variables, titles_smokers_general_health)

create_plots_general_health(non_smokers_df, general_health_variables, titles_non_smokers_general_health)
create_plots_general_health(e_smokers_df, general_health_variables, titles_e_smokers_general_health)
```
*Highlights:*

* General health perception of smokers and non-smokers quite similar (good or very-good mostly).Same for energy level and overall health, 38% of them don't have a walking limitations.

*Little another picture for e-smokers.Their energy level some times lower and distribution on overall health rate is higher tan for smokers and non-smokers. 45% don't have a walking limitations

```{r, eval=TRUE}
#deseases
create_plots_health_disease <- function(data, health_disease_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    vector_to_plot = data %>% filter(.data[[variable]] %in% c("1 YES", "2 NO")) %>%
      pull(variable) %>% factor()
    
    barplot(table(vector_to_plot), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in health_disease_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

health_disease_variables <- c("ASTHDX", "ARTHDX", "CALUNG", "CHOLDX", "CHBRON31", "DIABDX_M18", "EMPHDX", "HIBPDX", "STRKDX")

titles_smokers_health_disease <- c(
  ASTHDX = "Asthma Diagnosis (Smokers)",
  ARTHDX = "Arthritis Diagnosis (Smokers)",
  CALUNG = "Lung Cancer Diagnosis (Smokers)",
  CHOLDX = "Cholesterol Diagnosis (Smokers)",
  CHBRON31 = "Chronic Bronchitis Diagnosis (Smokers)",
  DIABDX_M18 = "Diabetes Diagnosis (Smokers)",
  EMPHDX = "Emphysema Diagnosis (Smokers)",
  HIBPDX = "High Blood Pressure Diagnosis (Smokers)",
  OHRTDX = "Heart Disease Diagnosis (Smokers)",
  OHRTTYPE = "Type of Heart Disease Diagnosis (Smokers)",
  STRKDX = "Stroke Diagnosis (Smokers)"
)

titles_non_smokers_health_disease <- c(
  ASTHDX = "Asthma Diagnosis (Non-Smokers)",
  ARTHDX = "Arthritis Diagnosis (Non-Smokers)",
  CALUNG = "Lung Cancer Diagnosis (Non-Smokers)",
  CHOLDX = "Cholesterol Diagnosis (Non-Smokers)",
  CHBRON31 = "Chronic Bronchitis Diagnosis (Non-Smokers)",
  DIABDX_M18 = "Diabetes Diagnosis (Non-Smokers)",
  EMPHDX = "Emphysema Diagnosis (Non-Smokers)",
  HIBPDX = "High Blood Pressure Diagnosis (Non-Smokers)",
  OHRTDX = "Heart Disease Diagnosis (Non-Smokers)",
  OHRTTYPE = "Type of Heart Disease Diagnosis (Non-Smokers)",
  STRKDX = "Stroke Diagnosis (Non-Smokers)"
)

create_plots_health_disease(smokers_df, health_disease_variables, titles_smokers_health_disease)


create_plots_health_disease(non_smokers_df, health_disease_variables, titles_non_smokers_health_disease)

```

## Contingency Tables

```{r, include= FALSE}
# defining functions to create contingency tables and chisquared tests

# this one takes two variables and returns the table
cont_tables = function(data, explanatory_var, var_of_interest, cond_prob = T){
  tbl = data %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table()
  if (cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
  }
  tbl
}

#this one takes two variables and an age group, allowing to check separately
#different ages
cont_tables_age = function(data, explanatory_var, var_of_interest,
                           age_bracket, cond_prob = T){
  tbl = data %>% filter(age_group == age_bracket) %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table()
  
  if(cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
    }
  tbl
}

#testing the functions

#smokers and diabetes
#conditional probabilities, for all observations, and for the last two age groups
# cont_tables(small_df,"ADSMOK42","DIABDX_M18") %>% knitr::kable()
# cont_tables_age(small_df,"ADSMOK42","DIABDX_M18","45-64")
# cont_tables_age(small_df,"ADSMOK42","DIABDX_M18","65+")
# 
# #chisquared tests for those tables
# cont_tables(small_df,"ADSMOK42","DIABDX_M18", F) %>% chisq.test(correct = F)
# cont_tables_age(small_df,"ADSMOK42","DIABDX_M18","45-64",F) %>% chisq.test(correct = F)
# cont_tables_age(small_df,"ADSMOK42","DIABDX_M18","65+",F) %>% chisq.test(correct = F)
# 
# # electronic nicotine and diabetes
# #conditional probabilities, for all observations, and for the last two age groups
# cont_tables(small_df,"SDENICPROD","DIABDX_M18")
# cont_tables_age(small_df,"SDENICPROD","DIABDX_M18","45-64")
# cont_tables_age(small_df,"SDENICPROD","DIABDX_M18","65+")
# 
# #chisquared tests for those tables
# cont_tables(small_df,"SDENICPROD","DIABDX_M18", F) %>% chisq.test(correct = F)
# cont_tables_age(small_df,"SDENICPROD","DIABDX_M18","45-64",F) %>% chisq.test(correct = F)
# cont_tables_age(small_df,"SDENICPROD","DIABDX_M18","65+",F) %>% chisq.test(correct = F)

```

```{r}
## to do:
# contingency tables and chisquared test for 2 explanatory vars:
# ADSMOK42 and SDENICPROD
# and 3 groups of response variables: general health, physical health, mental health

#starting with ADSMOK42 and physical health

titles_health_disease <- c(
  ASTHDX = "Asthma Diagnosis",
  ARTHDX = "Arthritis Diagnosis",
  CALUNG = "Lung Cancer Diagnosis",
  CHOLDX = "Cholesterol Diagnosis",
  CHBRON31 = "Chronic Bronchitis Diagnosis",
  DIABDX_M18 = "Diabetes Diagnosis",
  EMPHDX = "Emphysema Diagnosis",
  HIBPDX = "High Blood Pressure Diagnosis",
  OHRTDX = "Heart Disease Diagnosis",
  OHRTTYPE = "Type of Heart Disease Diagnosis",
  STRKDX = "Stroke Diagnosis"
)

for(variable in health_disease_variables){
  if("1 YES" %in% levels(small_df[[variable]])){
  print(titles_health_disease[variable])
  print("Contingency table")
  print(cont_tables(small_df, "ADSMOK42", variable)%>% round(digits=3))
  print("testing hypothesis of no association")
  print(cont_tables(small_df, "ADSMOK42", variable,F)%>% chisq.test(correct = F))
  print("------------")
  }

}

```
Summary of findings from contingency tables:

Asthma diagnosis: the association is statistically significant

Arthritis: also statistically significant

Lung cancer: p-value is just above 5%, the significance is weaker

Cholesterol Diagnosis: Smokers do have higher rates than non-smokers, but it's not statistically significant

Chronic Bronchitis: the association is statistically significant

Diabetes diagnosis: also statistically significant

Emphysema diagnosis: also statistically significant

High blood pressure: also statistically significant

Stroke diagnosis: also statistically significant

All the findings are promising: the contingency tables show strong association
between smoking and various diseases.
However this is not enough to draw conclusions: we need to control for other variables.
We know that the percentage of smokers is different for different age brackets, now we will repeat the test but only selecting one age bracket at the time

```{r}

chisq_df_diseases = data.frame(diseases = health_disease_variables,
                               p_val_full_data= rep(NA, length(health_disease_variables)),
                               p_val_65plus_data= rep(NA, length(health_disease_variables)),
                               p_val_45_64_data= rep(NA, length(health_disease_variables)))

for(i in 1:nrow(chisq_df_diseases)){
  variable = chisq_df_diseases[i,"diseases"]
  test_full = cont_tables(small_df,"ADSMOK42",variable, F) %>%
    chisq.test(correct = F)
  test_45_64 = cont_tables_age(small_df,"ADSMOK42",variable,"45-64",F) %>%
    chisq.test(correct = F)
  test_65plus = cont_tables_age(small_df,"ADSMOK42",variable,"65+",F) %>%
    chisq.test(correct = F)
  chisq_df_diseases[i,"p_val_full_data"] = test_full$p.val
  chisq_df_diseases[i,"p_val_45_64_data"] = test_45_64$p.val
  chisq_df_diseases[i,"p_val_65plus_data"] = test_65plus$p.val
  
}

chisq_df_diseases = chisq_df_diseases %>%
  rename(full_data = p_val_full_data,
         age_65plus = p_val_65plus_data,
         age_45_64 = p_val_45_64_data) %>%
  mutate(diseases = titles_health_disease[diseases]) %>%
  pivot_longer(cols=c("full_data","age_65plus","age_45_64"))

ggplot(chisq_df_diseases, aes(x = name, y = value)) +
  geom_col() + geom_hline(aes(yintercept = 0.05), col = "red") +
  facet_wrap(~diseases, scales = "free") + 
  labs(title="Testing hypothesis of no association between Smoking and various diseases",
       subtitle = "P-value of Chi squared test, controlling for age groups",
       x = "", y ="")+
  scale_x_discrete(labels = c("full_data" = "All patients",
                              "age_65plus" = "ages 45-64",
                              "age_45_64" = "ages 65 plus")) +
  theme_minimal() + theme(axis.text.x = element_text(size = 7))
  



```

### now we do the contingency tables for mental health variables instead of physical health

the main issue is that all those variables are multicategorical and not yes or no

```{r}
#writing functions to make contingency tables for multiple categories

table_mental_health = function(data, explanatory_var, var_of_interest, cond_prob = T){
  tbl = data %>%
    select(explanatory_var, var_of_interest)%>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           !.data[[var_of_interest]] %in% c("-15 CANNOT BE COMPUTED",
                                            "-1 INAPPLICABLE",
                                            "-8 DK","-7 REFUSED"))%>%
    mutate(across(c(1,2), factor)) %>%
    table()
  if (cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
  }
  tbl
}

#this one takes two variables and an age group, allowing to check separately
#different ages
table_mental_health_age = function(data, explanatory_var, var_of_interest,
                           age_bracket, cond_prob = T){
  tbl = data %>% filter(age_group == age_bracket) %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           !.data[[var_of_interest]] %in% c("-15 CANNOT BE COMPUTED",
                                            "-1 INAPPLICABLE",
                                            "-8 DK","-7 REFUSED"))%>%
    mutate(across(c(1,2), factor)) %>%
    table()
  
  if(cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
    }
  tbl
}

#plotting all the mental health variables

# "MNHLTH31"
table_mental_health(small_df, "ADSMOK42", "MNHLTH31") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = MNHLTH31)) +
  labs(title = "Contingency table: Perceived Mental Health status", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))


#"ADPCFL42"
table_mental_health(small_df, "ADSMOK42", "ADPCFL42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADPCFL42)) +
  labs(subtitle = "During the past 4 weeks, how often people felt calm and peaceful",
       title = "Contingency table: Smoking and feeling peaceful", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))


#"ADDPRS42"
table_mental_health(small_df, "ADSMOK42", "ADDPRS42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADDPRS42)) +
  labs(subtitle = "How many days in the past 2 weeks people felt down/depressed/hopeless",
       title = "Contingency table: Smoking and feeling down", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADHOPE42"
table_mental_health(small_df, "ADSMOK42", "ADHOPE42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADHOPE42)) +
  labs(subtitle = "During the past 30 days, how often people felt hopeless",
       title = "Contingency table: Smoking and feeling hopeless", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADNERV42"
table_mental_health(small_df, "ADSMOK42", "ADNERV42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADNERV42)) +
  labs(subtitle = "During the past 30 days, how often people felt nervous",
       title = "Contingency table: Smoking and feeling nervous", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADSAD42" 
table_mental_health(small_df, "ADSMOK42", "ADSAD42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADSAD42)) +
  labs(subtitle = "During the past 30 days, how often people felt so sad that nothing could cheer the person up",
       title = "Contingency table: Smoking and feeling sad", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))




```




Things to do: 
- 1 Introduction
- 2 Exploratory analysis: go deep into the dataset analyzing the most important
    variables.
- 3 Effect of smoking/nicotine on physical health: understand how much is dangerous 
    the abuse of smoke for the Pysichal healt
- 4 Effect of smoking/nicotine on mental health:understand how much is dangerous 
    the abuse of smoke for the mental healt
- 5 Conclusion
