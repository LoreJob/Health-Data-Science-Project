---
title: Health Data Science Project - Smoking and Electronic Nicotine
author: 
  - name: "Manuel Trevisan"
    email: "886937@stud.unive.it"
  - name: "Lorenzo Muscillo"
    email: "1000916@stud.unive.it"
  - name: "Giuseppe Massidda"
    email: "901029@stud.unive.it"
  - name: "Nilufar Iangiboeva"
    email: "902431@stud.unive.it"
output:
  html_document:
    fig_caption: yes
    theme: flatly #sandstone #spacelab #flatly
    highlight: pygments
    code_folding: show
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      smooth_scroll: FALSE
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Only need to run these once:
#  install.packages("foreign")  
#  install.packages("tidyverse")
#  install.packages("readr")
#  install.packages("readxl")
#  install.packages("haven")
#  install.packages("survey")
#  install.packages("remotes")


# Run these every time you re-start R:
  library(foreign)
  library(tidyverse)
  library(readr)
  library(readxl)
  library(haven)
  library(survey)
  library(remotes)
  library(jtools)
  library(VGAM)
  library(boot)
#  library(MEPS)
```

# Introduction

## Problem Statement 

The objective of this study is to investigate the negative health effects associated with smoking, including both physical and mental health outcomes. Given the widespread prevalence of smoking and the rising use of electronic nicotine products, it is crucial to understand the extent to which these habits impact overall health. Our analysis will focus on identifying the associations between smoking and various health-related issues, as well as exploring the relationship between smoking habits and mental health indicators. Additionally, we will compare these findings with the health effects associated with the use of electronic nicotine products.


The central question we want to answer is: what are the negative health effects associated with smoking?
We will look at the association between smoking and health related issues. We 
will also look at some mental health indicators and how they relate to smoking
habits. We will also make an interesting comparison with usage of electronic
nicotine products.

## Abstract
The negative health effects of smoking have been well-documented, yet the comprehensive impact on both physical and mental health continues to be a critical area of study. This research aims to analyze the associations between smoking and health-related issues using data from the 2021 Medical Expenditure Panel Survey Household Component, which surveyed 15,000 households in the United States. By examining physical health outcomes and mental health indicators, this study seeks to provide a detailed understanding of how smoking affects individuals. Furthermore, we will compare these effects with those associated with the use of electronic nicotine products, offering insights into the potential risks of these increasingly popular alternatives. Our findings aim to inform public health strategies and contribute to ongoing efforts to mitigate the health risks associated with smoking and electronic nicotine product usage.

The dataset we are working with is the Medical Expenditure Panel Survey Household
component of 2021. It's a survey conducted on 15000 households in the United States
of America.

*Here is info about characteristics:* <https://meps.ahrq.gov/data_files/publications/st554/stat554.shtml>

*Here is questionary report:* <https://meps.ahrq.gov/survey_comp/hc_survey/paper_quest/2021/2021_SHE_SAQ.pdf>

*Codebook:* <https://meps.ahrq.gov/data_stats/download_data/pufs/h233/h233cb.pdf>

```{r}
# the dataset is in the github repo, we don't need to download it every time
h233 <- read_dta("h233.dta")
head(h233)
```

Our main explanatory variables:

ADSMOK42: currently smokes

SDENICPROD: used electronic nicotine product

The other variables we selected are:

ADNSMK42 - If ADSMOK42 = 1, doctor advised you to quit smoking

Other variables we selected can be grouped as follows:

Demographic variables: AGELAST, REGION21, SEX, RACEV2X, MARRY21X, FTSTU21X, TTLP21X, FAMINC21, EMPST31

Mental health: ADDPRS42, ADHOPE42, ADNERV42, ADPCFL42, ADSAD42, MNHLTH31

General health: ADGENH42, ADENGY42, RTHLTH31, WLKLIM53

Disease Diagnosis: ASTHDX, ARTHDX, CALUNG, CHOLDX, CHBRON31, DIABDX_M18, EMPHDX, HIBPDX, STRKDX


```{r}
vars_to_keep = c("ADSMOK42","SDENICPROD","ADDPRS42","ADGENH42",
                 "ADENGY42","ADHOPE42","ADNERV42","ADPCFL42","ADSAD42",
                 "AGELAST","ASTHDX","CALUNG","CHOLDX","DIABDX_M18","EMPHDX",
                 "FAMINC21","HIBPDX","MNHLTH31","RTHLTH31","TTLP21X",
                 "WLKLIM53","SDCOMPAN","SDLEFTOUT","SDLIFE", 'REGION21', 'RACEV2X', 
                 'FTSTU21X', 'SEX','STRKDX','HIBPDX', 'MARRY21X','CHBRON31' ,'CANCERDX', 
                 'ARTHDX', 'ADNSMK42', 'SDHOME', 'SDMEDCARE','SDHLTHFOOD', 'SDISOL',
                 'SDHMDEPR','SDHMALC','SDHMDRG', 'SDHMDIV', 'SDHMBEAT', 'SDHURTCHLD', 'EMPST31')

small_df = h233 %>% select(all_of(vars_to_keep)) %>% as_factor()
#turning the variables into factors

small_df = small_df %>% mutate(age_group = cut(AGELAST,
                                    breaks = c(-Inf,18, 25, 35, 45, 65, Inf),
                  labels = c("0-18","18-24", "25-34", "35-44", "45-64", "65+"),
                  right = FALSE))
#adding a new variable to break into age groups

small_df %>% summary()

```


# Descriptive statistics

## Demographic characteristics

We start by looking at the age distribution of people that took the survey

```{r}
#smokers by age group
small_df %>% select(ADSMOK42, age_group) %>% group_by(age_group) %>%
  summarise(n_smokers = sum(ADSMOK42 == "1 YES"),
            n_non_smokers = sum(ADSMOK42 == "2 NO"),
            n_inapplicable = sum(ADSMOK42 == "-1 INAPPLICABLE")) %>%
  mutate(perc_smokers = 100*n_smokers/n_non_smokers) %>% 
  slice(-1) %>%
  ggplot(aes(x = age_group)) +
  geom_col(aes(y = n_non_smokers, fill = "non smokers")) +
  geom_col(aes(y = n_smokers, fill = "smokers")) +
  geom_text(aes(label=paste(round(perc_smokers,2),"%"), y = 130)) +
  labs(title = "Age distribution of smokers and non smokers",
       y = "count", x = "age group", fill = "") + theme_classic()


# age distribution of users of electronic cigarettes 
small_df %>% select(SDENICPROD, age_group) %>% group_by(age_group) %>%
  summarise(n_smokers = sum(SDENICPROD == "1 YES"),
            n_non_smokers = sum(SDENICPROD == "2 NO"),
            n_inapplicable = sum(SDENICPROD == "-1 INAPPLICABLE")) %>%
  mutate(perc_smokers = 100*n_smokers/n_non_smokers) %>% 
  slice(-1) %>%
  ggplot(aes(x = age_group)) +
  geom_col(aes(y = n_non_smokers, fill = "non users")) +
  geom_col(aes(y = n_smokers, fill = "users")) +
  geom_text(aes(label=paste(round(perc_smokers,2),"%"), y = 130)) +
  labs(title = "Age distribution of electronic nicotine product usage",
       y = "count", x = "age group", fill = "") + theme_classic()


```


Smoking rate increases with age, till the 45-64 age group. They are the most likely
to smoke. However the last age group, 65 and over is the one with the lowest rate.
This fact is key to understand the effect of age: as is well known, general health
decreases sharply with old age, so it will be important in our analysis to always control
for the confounding effect of age.

Looking at electronic nicotine usage, we see a very different picture: in the youngest 
group there is a really high rate, 41%. Almost one every two young adults uses those
products. The rate is decreasing with age: every older generation show a large decrease
from the younger one. The 65+ group, which as we have already said is the one with the
worst health, sees almost no usage: just over 5%.

The two variables will allow us to make interesting comparisons since the makeup of
the groups is very different.

 

```{r}
small_df <- small_df %>%
  mutate(
    sex_group = case_when(
      SEX == '1 MALE' ~ 'MALE',
      SEX == '2 FEMALE' ~ 'FEMALE',
      TRUE ~ NA_character_
    )
  )
smokers_df <- small_df %>% filter(ADSMOK42 == "1 YES")

non_smokers_df <- small_df %>% filter(ADSMOK42 == "2 NO")

e_smokers_df <-small_df %>% filter(SDENICPROD == "1 YES")

```
 
### Difference between smokers and non-smokers 

```{r}

create_plots_demogr <- function(data, demographic_variables, titles) {
  data <- data %>%
    mutate(
      tot_inc_group = cut(TTLP21X,
                          breaks = c(-Inf, 10000, 15000, 20000, 25000, 30000, Inf),
                          labels = c("0-10000", "10001-15000", "15001-20000", "20001-25000", "25001-30000", "30000+"),
                          right = FALSE),
      fam_inc_group = cut(FAMINC21,
                          breaks = c(-Inf, 10000, 15000, 20000, 25000, 30000, Inf),
                          labels = c("0-10000", "10001-15000", "15001-20000", "20001-25000", "25001-30000", "30000+"),
                          right = FALSE)
    ) %>%
    filter(!is.na(tot_inc_group) & !is.na(fam_inc_group) & !is.na(sex_group)) %>%
    filter(tot_inc_group != "NA")
  
  create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in demographic_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

demographic_variables <- c("age_group", "REGION21", "sex_group", "RACEV2X", "MARRY21X", "FTSTU21X", "tot_inc_group", "fam_inc_group", "EMPST31")

titles_smokers <- c(
  age_group = "Age Group Distribution (Smokers)",
  REGION21 = "Region Distribution (Smokers)",
  sex_group = "Gender Distribution (Smokers)",
  RACEV2X = "Race Distribution (Smokers)",
  MARRY21X = "Marital Status Distribution (Smokers)",
  FTSTU21X = "Full-Time Student Distribution (Smokers)",
  tot_inc_group = "Total Income Distribution (Smokers)",
  fam_inc_group = "Family Income Distribution (Smokers)",
  EMPST31 = "Employment Status Distribution (Smokers)"
)

titles_non_smokers <- c(
  age_group = "Age Group Distribution (Non-Smokers)",
  REGION21 = "Region Distribution (Non-Smokers)",
  sex_group = "Gender Distribution (Non-Smokers)",
  RACEV2X = "Race Distribution (Non-Smokers)",
  MARRY21X = "Marital Status Distribution (Non-Smokers)",
  FTSTU21X = "Full-Time Student Distribution (Non-Smokers)",
  tot_inc_group = "Total Income Distribution (Non-Smokers)",
  fam_inc_group = "Family Income Distribution (Non-Smokers)",
  EMPST31 = "Employment Status Distribution (Non-Smokers)"
)


create_plots_demogr(smokers_df, demographic_variables, titles_smokers)

create_plots_demogr(non_smokers_df, demographic_variables, titles_non_smokers)

```
**Highlights**
*A collective image of smokers:*
* 40% are 45-64 y.o.
* 44% living in South region, ~22% in Midwest and ~22% in West
* 49% of male and 51% of female
* 70% of white race and 22% of black
* 32% never married, 31% married, just 21% divorced and 10% widowed
* 4% not a students, 1% full-time student, 0,31% part-time students
* Mean of total income is 30586, ~51% earn 30000+, ~25% earn less than 10000
* Mean of total income of family is 50665, 55% earn 30000+, other family's income distributed gradually in income range
* 50% are not employed during RD, 46% employed

*A collective image of non-smokers:*
* 36% are 65+ y.o., 31% are 45-64 y.o.
* 37% living in South region, 22% in Midwest and ~26% in West
* 56% of male and 44% of female
* 79% of white race and 11% of black
* 24% never married, 50% married, just 14% divorced and 10% widowed
* 4% not a students, 2,6 % full-time student, 0,04% part-time students
* Mean of total income is 47740, ~55% earn 30000+
* Mean of total income of family is 85484 , 44% earn 30000+,other family's income distributed gradually in income range
* 45% are not employed during RD, 53% employed


Did smokers receive a doctor's recommendation to quit? 
```{r}
ggplot(smokers_df, aes(x = ADNSMK42)) +
  geom_bar(fill = "skyblue") +
  labs(title = "Distribution of Smokers by Doctor's Recommendation", x = "Doctor's Recommendation", y = "Frequency") + theme_classic()
```
*38% of current smokers still smokes after doctor's advice to quit smoke*

Smokers that also make use of electronic nicotine products
```{r}
ggplot(smokers_df, aes(x = SDENICPROD == "1 YES")) +
  geom_bar(fill = "lightcoral") +
  labs(title = "Distribution of e-Smokers through current smokers", x = "E-smokers No/Yes", y = "Count") + theme_classic()
```
*Current smokers make use of e-cigarettes at only 21% rate*

This is the main reason why we looked at the two explanatory variables separately:
the group that uses both is really small with only 700 people in a sample of 28,000 people



## Mental Health Variables

```{r}
#mental health
create_plots_mental_health <- function(data, mental_health_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
 create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in mental_health_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

mental_health_variables <- c("ADDPRS42", "ADHOPE42", "ADNERV42", "ADPCFL42", "ADSAD42", "MNHLTH31")


titles_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (Smokers)",
  ADHOPE42 = "Hopefulness (Smokers)",
  ADNERV42 = "Nervousness (Smokers)",
  ADPCFL42 = "Psychological Fatigue (Smokers)",
  ADSAD42 = "Sadness (Smokers)",
  MNHLTH31 = "Mental Health Status (Smokers)"
)

titles_non_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (Non-Smokers)",
  ADHOPE42 = "Hopefulness (Non-Smokers)",
  ADNERV42 = "Nervousness (Non-Smokers)",
  ADPCFL42 = "Psychological Fatigue (Non-Smokers)",
  ADSAD42 = "Sadness (Non-Smokers)",
  MNHLTH31 = "Mental Health Status (Non-Smokers)"
)

titles_e_smokers_mental_health <- c(
  ADDPRS42 = "Perceived Stress (E-Smokers)",
  ADHOPE42 = "Hopefulness (E-Smokers)",
  ADNERV42 = "Nervousness (E-Smokers)",
  ADPCFL42 = "Psychological Fatigue (E-Smokers)",
  ADSAD42 = "Sadness (E-Smokers)",
  MNHLTH31 = "Mental Health Status (E-Smokers)"
)
create_plots_mental_health(smokers_df, mental_health_variables, titles_smokers_mental_health)
create_plots_mental_health(non_smokers_df, mental_health_variables, titles_non_smokers_mental_health)
create_plots_mental_health(e_smokers_df, mental_health_variables, titles_e_smokers_mental_health)
```
*Highlights*

* Mostly smokers don't perceived stress, hopefulness and sadness, nervousness mostly also no, but 25% little of the time. 36% of smokers little of the time have psychological fatigue. 35% smokers have a goog mental health, 24% very good mental health, 21% excellent and just 14% fair.

*In comparison, non-smokers mostly don't feel perceived stress, hopefulness and sadness. However, that mental health status is better: 40% have very good, 28% excellent and 28% good, just 7% fair.

*Another picture for e-smokers: mostly of them don't have perceived stress and hopefulness, but 24% fill little of time nervous and 15% some of the time. 27% little of the time have psychological fatigue, ~16% have it most of the time. Overall, 14% feel fair, mental health is more than less good or excellent. 



## General Health Variables

```{r}
create_plots_general_health <- function(data, general_health_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    barplot(table(data[[variable]]), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 2)) 
  for (variable in general_health_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

general_health_variables <- c("ADGENH42", "ADENGY42", "RTHLTH31", "WLKLIM53")


titles_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (Smokers)",
  ADENGY42 = "Energy Level (Smokers)",
  RTHLTH31 = "Overall Health Rating (Smokers)",
  WLKLIM53 = "Walking Limitation (Smokers)"
)

titles_non_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (Non-Smokers)",
  ADENGY42 = "Energy Level (Non-Smokers)",
  RTHLTH31 = "Overall Health Rating (Non-Smokers)",
  WLKLIM53 = "Walking Limitation (Non-Smokers)"
)

titles_e_smokers_general_health <- c(
  ADGENH42 = "General Health Perception (E-Smokers)",
  ADENGY42 = "Energy Level (E-Smokers)",
  RTHLTH31 = "Overall Health Rating (E-Smokers)",
  WLKLIM53 = "Walking Limitation (E-Smokers)"
)


create_plots_general_health(smokers_df, general_health_variables, titles_smokers_general_health)

create_plots_general_health(non_smokers_df, general_health_variables, titles_non_smokers_general_health)
create_plots_general_health(e_smokers_df, general_health_variables, titles_e_smokers_general_health)
```
*Highlights:*

* General health perception of smokers and non-smokers quite similar (good or very-good mostly).Same for energy level and overall health, 38% of them don't have a walking limitations.

*Little another picture for e-smokers.Their energy level some times lower and distribution on overall health rate is higher tan for smokers and non-smokers. 45% don't have a walking limitations


## Diseases Diagnosis

```{r, eval=TRUE}
#deseases
create_plots_health_disease <- function(data, health_disease_variables, titles) {
  data <- data %>%
    filter(!is.na(sex_group))
  
create_plots <- function(data, variable, title) {
    my_colors <- c("skyblue", "salmon", "lightgreen", "lightpink", "lightblue", "lightcoral")
    vector_to_plot = data %>% filter(.data[[variable]] %in% c("1 YES", "2 NO")) %>%
      pull(variable) %>% factor()
    
    barplot(table(vector_to_plot), main = title, xlab = variable, ylab = "Frequency", las = 2, cex.names = 0.8, col = my_colors)
  }
  
  par(mfrow = c(1, 3)) 
  for (variable in health_disease_variables) {
    create_plots(data, variable, titles[[variable]])
  }
}

health_disease_variables <- c("ASTHDX", "ARTHDX", "CALUNG", "CHOLDX", "CHBRON31", "DIABDX_M18", "EMPHDX", "HIBPDX", "STRKDX")

titles_smokers_health_disease <- c(
  ASTHDX = "Asthma Diagnosis (Smokers)",
  ARTHDX = "Arthritis Diagnosis (Smokers)",
  CALUNG = "Lung Cancer Diagnosis (Smokers)",
  CHOLDX = "Cholesterol Diagnosis (Smokers)",
  CHBRON31 = "Chronic Bronchitis Diagnosis (Smokers)",
  DIABDX_M18 = "Diabetes Diagnosis (Smokers)",
  EMPHDX = "Emphysema Diagnosis (Smokers)",
  HIBPDX = "High Blood Pressure Diagnosis (Smokers)",
  OHRTDX = "Heart Disease Diagnosis (Smokers)",
  OHRTTYPE = "Type of Heart Disease Diagnosis (Smokers)",
  STRKDX = "Stroke Diagnosis (Smokers)"
)

titles_non_smokers_health_disease <- c(
  ASTHDX = "Asthma Diagnosis (Non-Smokers)",
  ARTHDX = "Arthritis Diagnosis (Non-Smokers)",
  CALUNG = "Lung Cancer Diagnosis (Non-Smokers)",
  CHOLDX = "Cholesterol Diagnosis (Non-Smokers)",
  CHBRON31 = "Chronic Bronchitis Diagnosis (Non-Smokers)",
  DIABDX_M18 = "Diabetes Diagnosis (Non-Smokers)",
  EMPHDX = "Emphysema Diagnosis (Non-Smokers)",
  HIBPDX = "High Blood Pressure Diagnosis (Non-Smokers)",
  OHRTDX = "Heart Disease Diagnosis (Non-Smokers)",
  OHRTTYPE = "Type of Heart Disease Diagnosis (Non-Smokers)",
  STRKDX = "Stroke Diagnosis (Non-Smokers)"
)

create_plots_health_disease(smokers_df, health_disease_variables, titles_smokers_health_disease)


create_plots_health_disease(non_smokers_df, health_disease_variables, titles_non_smokers_health_disease)

```

We immediately see that some diseases are very rare, while others are quite common.

```{r}

condition_labels <- c(
  "Asthma Diagnosis",
  "Arthritis Diagnosis",
  "Lung Cancer Diagnosis",
  "Cholesterol Diagnosis",
  "Chronic Bronchitis Diagnosis",
  "Diabetes Diagnosis",
  "Emphysema Diagnosis",
  "High Blood Pressure Diagnosis",
  "Stroke Diagnosis"
)



diseases_percentages = small_df %>% filter(AGELAST >= 18) %>%
  select(ADSMOK42, all_of(health_disease_variables)) %>% group_by(ADSMOK42) %>%
  summarise(ASTHDX = sum(ASTHDX == "1 YES")/sum(ASTHDX %in% c("1 YES","2 NO")),
            ARTHDX = sum(ARTHDX == "1 YES")/sum(ARTHDX %in% c("1 YES","2 NO")),
            CALUNG = sum(CALUNG == "1 YES")/sum(CALUNG %in% c("1 YES","2 NO")),
            CHOLDX = sum(CHOLDX == "1 YES")/sum(CHOLDX %in% c("1 YES","2 NO")),
            CHBRON31 = sum(CHBRON31 == "1 YES")/sum(CHBRON31 %in% c("1 YES","2 NO")),
            DIABDX_M18 = sum(DIABDX_M18 == "1 YES")/sum(DIABDX_M18 %in% c("1 YES","2 NO")),
            EMPHDX = sum(EMPHDX == "1 YES")/sum(EMPHDX %in% c("1 YES","2 NO")),
            HIBPDX = sum(HIBPDX == "1 YES")/sum(HIBPDX %in% c("1 YES","2 NO")),
            STRKDX = sum(STRKDX == "1 YES")/sum(STRKDX %in% c("1 YES","2 NO"))) %>%
  pivot_longer(cols = health_disease_variables) %>%
  rename(percentage = value , condition = name) %>%
  mutate(condition = factor(condition,
                            levels = health_disease_variables,
                            labels = condition_labels))

diseases_percentages %>% filter(ADSMOK42 == "1 YES") %>%
  ggplot(aes(x = condition, y = percentage*100, fill = condition)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "Percentage of Smokers 18 or Older \nWho Report Specific Health Diseases",
      x = "",
      y = "Percentage"
    ) +
    theme_classic() +
    theme(legend.position = "none")

diseases_percentages %>% filter(ADSMOK42 == "2 NO") %>%
  ggplot(aes(x = condition, y = percentage*100, fill = condition)) +
    geom_col() +
    coord_flip() +
    labs(
      title = "Percentage of non-Smokers 18 or Older \nWho Report Specific Health Diseases",
      x = "",
      y = "Percentage"
    ) +
    theme_classic() +
    theme(legend.position = "none")


diseases_percentages %>% filter(ADSMOK42 != "-1 INAPPLICABLE") %>%
  mutate(ADSMOK42 = factor(ADSMOK42, levels = c("1 YES","2 NO"), 
                           labels = c("Smokers","Non-Smokers"))) %>%
  mutate(ADSMOK42 = relevel(ADSMOK42, "Non-Smokers")) %>%
  ggplot(aes(x = condition, y = percentage*100, fill = ADSMOK42)) +
    geom_col(position = position_dodge()) +
    coord_flip() +
    labs(
      title = "Percentage of people 18 or Older Who Report Specific Diseases",
      x = "",
      y = "Percentage"
    ) +
  theme(legend.title = element_blank())


```
```{r}
# recreate the plot above but with electronic nicotine

diseases_percentages = small_df %>% filter(AGELAST >= 18) %>%
  select(SDENICPROD, all_of(health_disease_variables)) %>% group_by(SDENICPROD) %>%
  summarise(ASTHDX = sum(ASTHDX == "1 YES")/sum(ASTHDX %in% c("1 YES","2 NO")),
            ARTHDX = sum(ARTHDX == "1 YES")/sum(ARTHDX %in% c("1 YES","2 NO")),
            CALUNG = sum(CALUNG == "1 YES")/sum(CALUNG %in% c("1 YES","2 NO")),
            CHOLDX = sum(CHOLDX == "1 YES")/sum(CHOLDX %in% c("1 YES","2 NO")),
            CHBRON31 = sum(CHBRON31 == "1 YES")/sum(CHBRON31 %in% c("1 YES","2 NO")),
            DIABDX_M18 = sum(DIABDX_M18 == "1 YES")/sum(DIABDX_M18 %in% c("1 YES","2 NO")),
            EMPHDX = sum(EMPHDX == "1 YES")/sum(EMPHDX %in% c("1 YES","2 NO")),
            HIBPDX = sum(HIBPDX == "1 YES")/sum(HIBPDX %in% c("1 YES","2 NO")),
            STRKDX = sum(STRKDX == "1 YES")/sum(STRKDX %in% c("1 YES","2 NO"))) %>%
  pivot_longer(cols = health_disease_variables) %>%
  rename(percentage = value , condition = name) %>%
  mutate(condition = factor(condition,
                            levels = health_disease_variables,
                            labels = condition_labels))



diseases_percentages %>% filter(SDENICPROD %in% c("1 YES","2 NO")) %>%
  mutate(SDENICPROD = factor(SDENICPROD, levels = c("1 YES","2 NO"), 
                           labels = c("Users of E-nic. Prods","Non-Users"))) %>%
  mutate(SDENICPROD = relevel(SDENICPROD, "Non-Users")) %>%
  ggplot(aes(x = condition, y = percentage*100, fill = SDENICPROD)) +
    geom_col(position = position_dodge()) +
    coord_flip() +
    labs(
      title = "Disease Rates among Users of Electronic Nicotine Products",
      x = "",
      y = "Percentage"
    ) +
  theme(legend.title = element_blank())

```


# Contingency Tables

## Smoking

### Smoking and Diseases

```{r, include= FALSE}
# defining functions to create contingency tables and chisquared tests

# this one takes two variables and returns the table
cont_tables = function(data, explanatory_var, var_of_interest, cond_prob = T){
  tbl = data %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table()
  if (cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
  }
  tbl
}

#this one takes two variables and an age group, allowing to check separately
#different ages
cont_tables_age = function(data, explanatory_var, var_of_interest,
                           age_bracket, cond_prob = T){
  tbl = data %>% filter(age_group == age_bracket) %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table()
  
  if(cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
    }
  tbl
}

```

```{r}
# contingency tables and chisquared test for
# ADSMOK42


#starting with ADSMOK42 and physical health

titles_health_disease <- c(
  ASTHDX = "Asthma Diagnosis",
  ARTHDX = "Arthritis Diagnosis",
  CALUNG = "Lung Cancer Diagnosis",
  CHOLDX = "Cholesterol Diagnosis",
  CHBRON31 = "Chronic Bronchitis Diagnosis",
  DIABDX_M18 = "Diabetes Diagnosis",
  EMPHDX = "Emphysema Diagnosis",
  HIBPDX = "High Blood Pressure Diagnosis",
  STRKDX = "Stroke Diagnosis"
)

for(variable in health_disease_variables){
  if("1 YES" %in% levels(small_df[[variable]])){
  print(titles_health_disease[variable])
  print("Contingency table")
  print(cont_tables(small_df, "ADSMOK42", variable)%>% round(digits=3))
  print("testing hypothesis of no association")
  print(cont_tables(small_df, "ADSMOK42", variable,F)%>% chisq.test(correct = F))
  print("------------")
  }

}

```
Summary of findings from contingency tables:

Asthma diagnosis: the association is statistically significant

Arthritis: also statistically significant

Lung cancer: p-value is just above 5%, the significance is weaker

Cholesterol Diagnosis: Smokers do have higher rates than non-smokers, but it's not statistically significant

Chronic Bronchitis: the association is statistically significant

Diabetes diagnosis: also statistically significant

Emphysema diagnosis: also statistically significant

High blood pressure: also statistically significant

Stroke diagnosis: also statistically significant

All the findings are promising: the contingency tables show strong association
between smoking and various diseases.
However this is not enough to draw conclusions: we need to control for other variables.
We know that the percentage of smokers is different for different age brackets, now we will repeat the test but only selecting one age bracket at the time

```{r}

chisq_df_diseases = data.frame(diseases = health_disease_variables,
                               p_val_full_data= rep(NA, length(health_disease_variables)),
                               p_val_65plus_data= rep(NA, length(health_disease_variables)),
                               p_val_45_64_data= rep(NA, length(health_disease_variables)))

for(i in 1:nrow(chisq_df_diseases)){
  variable = chisq_df_diseases[i,"diseases"]
  test_full = cont_tables(small_df,"ADSMOK42",variable, F) %>%
    chisq.test(correct = F)
  test_45_64 = cont_tables_age(small_df,"ADSMOK42",variable,"45-64",F) %>%
    chisq.test(correct = F)
  test_65plus = cont_tables_age(small_df,"ADSMOK42",variable,"65+",F) %>%
    chisq.test(correct = F)
  chisq_df_diseases[i,"p_val_full_data"] = test_full$p.val
  chisq_df_diseases[i,"p_val_45_64_data"] = test_45_64$p.val
  chisq_df_diseases[i,"p_val_65plus_data"] = test_65plus$p.val
}

chisq_df_diseases = chisq_df_diseases %>%
  mutate(diseases = titles_health_disease[diseases]) %>%
  pivot_longer(cols=c("p_val_full_data","p_val_65plus_data","p_val_45_64_data"))

ggplot(chisq_df_diseases, aes(x = name, y = value)) +
  geom_col() + geom_hline(aes(yintercept = 0.05), col = "red") +
  facet_wrap(~diseases, scales = "free") + 
  labs(title="Testing hypothesis of no association between Smoking and various diseases",
       subtitle = "P-value of Chi squared test, controlling for age groups",
       x = "", y ="")+
  scale_x_discrete(labels = c("p_val_full_data" = "All patients",
                              "p_val_65plus_data" = "65 plus",
                              "p_val_45_64_data" = "45-64")) +
  theme_minimal() + theme(axis.text.x = element_text(size = 7))
  



```

We can also look at the odds ratio.

```{r}

or_data_all = expand.grid(diseases = health_disease_variables,
                      age = "all",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_all)){
  var_of_interest = as.character(or_data_all$diseases[i])
  or = small_df %>%
    select(ADSMOK42,var_of_interest)%>%
    filter(ADSMOK42 %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_all[i,"estimate"] = or$measure[2,"estimate"]
  or_data_all[i,"lower"] = or$measure[2,"lower"]
  or_data_all[i,"upper"] = or$measure[2,"upper"]
}

or_data_45_64 = expand.grid(diseases = health_disease_variables,
                      age = "45_64",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_45_64)){
  var_of_interest = as.character(or_data_45_64$diseases[i])
  or = small_df %>% filter(age_group == "45-64") %>%
    select(ADSMOK42,var_of_interest)%>%
    filter(ADSMOK42 %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_45_64[i,"estimate"] = or$measure[2,"estimate"]
  or_data_45_64[i,"lower"] = or$measure[2,"lower"]
  or_data_45_64[i,"upper"] = or$measure[2,"upper"]
}


or_data_65plus = expand.grid(diseases = health_disease_variables,
                      age = "65plus",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_65plus)){
  var_of_interest = as.character(or_data_65plus$diseases[i])
  or = small_df %>% filter(age_group == "65+") %>%
    select(ADSMOK42,var_of_interest)%>%
    filter(ADSMOK42 %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_65plus[i,"estimate"] = or$measure[2,"estimate"]
  or_data_65plus[i,"lower"] = or$measure[2,"lower"]
  or_data_65plus[i,"upper"] = or$measure[2,"upper"]
}

or_data = rbind(or_data_all,or_data_45_64,or_data_65plus)

or_data %>% mutate(diseases = titles_health_disease[diseases]) %>%
  ggplot(aes(x = age)) + geom_point(aes(y = estimate)) +
  geom_segment(aes(x = age, xend = age, y = lower, yend = upper))+
  geom_hline(aes(yintercept  = 1), col = "red")+
  facet_wrap(~diseases, scales = "free") +
  labs(title="Odds ratio of disease diagnosis for Smokers and Non-Smokers",
       subtitle = "95% confidence intervals for different age groups",
       x = "", y ="")+
  scale_x_discrete(labels = c("all" = "All",
                              "65plus" = "65 and over" ,
                              "45_64" = "45-64")) +
  theme_minimal() + theme(axis.text.x = element_text(size = 7))
```


### Smoking and Mental Health

```{r}
#writing functions to make contingency tables for multiple categories

table_multi_cat = function(data, explanatory_var, var_of_interest, cond_prob = T){
  tbl = data %>%
    select(explanatory_var, var_of_interest)%>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           !.data[[var_of_interest]] %in% c("-15 CANNOT BE COMPUTED",
                                            "-1 INAPPLICABLE",
                                            "-8 DK","-7 REFUSED"))%>%
    mutate(across(c(1,2), factor)) %>%
    table()
  if (cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
  }
  tbl
}

#this one takes two variables and an age group, allowing to check separately
#different ages
table_multi_cat_age = function(data, explanatory_var, var_of_interest,
                           age_bracket, cond_prob = T){
  tbl = data %>% filter(age_group == age_bracket) %>%
    select(explanatory_var,var_of_interest) %>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           !.data[[var_of_interest]] %in% c("-15 CANNOT BE COMPUTED",
                                            "-1 INAPPLICABLE",
                                            "-8 DK","-7 REFUSED"))%>%
    mutate(across(c(1,2), factor)) %>%
    table()
  
  if(cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
    }
  tbl
}

#plotting all the mental health variables

# "MNHLTH31"
table_multi_cat(small_df, "ADSMOK42", "MNHLTH31") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = MNHLTH31)) +
  labs(title = "Contingency table: Perceived Mental Health status", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))


#"ADPCFL42"
table_multi_cat(small_df, "ADSMOK42", "ADPCFL42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADPCFL42)) +
  labs(subtitle = "During the past 4 weeks, how often people felt calm and peaceful",
       title = "Contingency table: Smoking and feeling peaceful", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))


#"ADDPRS42"
table_multi_cat(small_df, "ADSMOK42", "ADDPRS42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADDPRS42)) +
  labs(subtitle = "How many days in the past 2 weeks people felt down/depressed/hopeless",
       title = "Contingency table: Smoking and feeling down", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADHOPE42"
table_multi_cat(small_df, "ADSMOK42", "ADHOPE42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADHOPE42)) +
  labs(subtitle = "During the past 30 days, how often people felt hopeless",
       title = "Contingency table: Smoking and feeling hopeless", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADNERV42"
table_multi_cat(small_df, "ADSMOK42", "ADNERV42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADNERV42)) +
  labs(subtitle = "During the past 30 days, how often people felt nervous",
       title = "Contingency table: Smoking and feeling nervous", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

# "ADSAD42" 
table_multi_cat(small_df, "ADSMOK42", "ADSAD42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADSAD42)) +
  labs(subtitle = "During the past 30 days, how often people felt so sad that nothing could cheer the person up",
       title = "Contingency table: Smoking and feeling sad", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))




```

```{r}
# looking at how the contingency table for perceived mental health and smoking
# is different in the different age groups
age_18_24 = table_multi_cat_age(small_df, "ADSMOK42", "MNHLTH31", "18-24") %>% as_tibble %>%
  mutate(age = "18-24")
age_25_34 = table_multi_cat_age(small_df, "ADSMOK42", "MNHLTH31", "25-34") %>% as_tibble %>%
  mutate(age = "25-34")
age_35_44 = table_multi_cat_age(small_df, "ADSMOK42", "MNHLTH31", "35-44") %>% as_tibble %>%
  mutate(age = "35-44")
age_45_64 = table_multi_cat_age(small_df, "ADSMOK42", "MNHLTH31", "45-64") %>% as_tibble %>%
  mutate(age = "45-64")
age_65plus = table_multi_cat_age(small_df, "ADSMOK42", "MNHLTH31", "65+") %>% as_tibble %>%
  mutate(age = "65+")

all_tables = rbind(age_18_24,age_25_34,age_35_44,age_45_64,age_65plus)

all_tables %>% mutate(age = factor(age)) %>%
  ggplot(aes(x = n, fill = MNHLTH31, y = ADSMOK42)) +
  geom_col(orientation = "y") +
  facet_grid(rows = vars(age))+
  labs(title = "Perceived Mental Health and smoking in different age groups", y = "",
       subtitle = "Contingency tables with conditional probability", x="frequency", fill="Perceived Mental Health") +
  scale_y_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))+
  theme(strip.text.y = element_text(angle = 0))





```


```{r}
# looking at how the contingency table for "ADDPRS42" and smoking
# is different in the different age groups
age_18_24 = table_multi_cat_age(small_df, "ADSMOK42", "ADDPRS42", "18-24") %>% as_tibble %>%
  mutate(age = "18-24")
age_25_34 = table_multi_cat_age(small_df, "ADSMOK42", "ADDPRS42", "25-34") %>% as_tibble %>%
  mutate(age = "25-34")
age_35_44 = table_multi_cat_age(small_df, "ADSMOK42", "ADDPRS42", "35-44") %>% as_tibble %>%
  mutate(age = "35-44")
age_45_64 = table_multi_cat_age(small_df, "ADSMOK42", "ADDPRS42", "45-64") %>% as_tibble %>%
  mutate(age = "45-64")
age_65plus = table_multi_cat_age(small_df, "ADSMOK42", "ADDPRS42", "65+") %>% as_tibble %>%
  mutate(age = "65+")

all_tables = rbind(age_18_24,age_25_34,age_35_44,age_45_64,age_65plus)

all_tables %>% mutate(age = factor(age)) %>%
  ggplot(aes(x = n, fill = ADDPRS42, y = ADSMOK42)) +
  geom_col(orientation = "y") +
  facet_grid(rows = vars(age))+
  labs(subtitle = "How many days in the past 2 weeks people felt down/depressed/hopeless",
       y = "", fill="How many days people felt down",
       title = "Contingency table: Smoking and feeling down", x="frequency", ) +
  scale_y_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))+
  theme(strip.text.y = element_text(angle = 0))






```

In general, we can say that the mental health of non-smokers is better across all
indicators, and age doesn't seem to have any impact on this. This is expected, because
old age is not associated with worse mental health as strongly as it is associated with
physical and general health.


### General Health and Smoking
```{r}

#ADGENH42
table_multi_cat(small_df, "ADSMOK42", "ADGENH42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADGENH42)) +
  labs(title = "Contingency table: Smoking and General health", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))
#RTHLTH31
table_multi_cat(small_df, "ADSMOK42", "RTHLTH31") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = RTHLTH31)) +
  labs(title = "Contingency table: Smoking and Perceived Health Status", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

#ADENGY42
table_multi_cat(small_df, "ADSMOK42", "ADENGY42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = ADENGY42)) +
  labs(subtitle = "During the past 4 weeks, how many people had a lot of energy",
       title = "Contingency table: Smoking and energy", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

#WLKLIM53

table_multi_cat(small_df, "ADSMOK42", "WLKLIM53") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = ADSMOK42, y = n, fill = WLKLIM53)) +
  labs(title = "Contingency table: Smoking and Limitation in Physical Functioning", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Smokers",
                              "2 NO" = "Non Smokers"))

```

We see what we were expecting: the general health of smokers is worse.
Non-Smokers are healthier, feel healthier and have more energy.
We also see that among smokers there is a much higher rate of limitation in physical
functioning. It's hard to look for a direct causality between the two: there are many interactions between different demographic factors. We can explore this deeper, we will
look at this association in different age groups.

```{r}
# odds ratio: smoking and walking limitations in different age groups

table_multi_cat_control = function(data, explanatory_var, var_of_interest, cond_prob = T){
  tbl = data %>%
    select(explanatory_var, var_of_interest,age_group)%>%
    filter(.data[[explanatory_var]] %in% c("1 YES", "2 NO"),
           !.data[[var_of_interest]] %in% c("-15 CANNOT BE COMPUTED",
                                            "-1 INAPPLICABLE",
                                            "-8 DK","-7 REFUSED"))%>%
    mutate(across(c(1,2), factor)) %>%
    table()
  if (cond_prob){
    tbl = tbl %>% prop.table(margin = 1)
  }
  tbl
}



table_multi_cat_control(small_df, "ADSMOK42", "WLKLIM53",F) %>% as_tibble() %>%
  filter(age_group != "0-18") %>%
  group_by(age_group) %>%
  summarise(or_estimate = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"estimate"],
            or_lower = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"lower"],
            or_upper = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"upper"]) %>%
  mutate(age_group = factor(age_group)) %>%
  ggplot() +
  geom_point(aes(x = age_group, y = or_estimate)) +
  geom_segment(aes(x = age_group,xend=age_group,
                   y = or_lower, yend=or_upper))+
  geom_hline(aes(yintercept =1), col = "red") +
  labs(title = "Smoking and Limitation in Physical Functioning across different ages",
       subtitle = "95% confidence intervals for odds ratio",
       x = "Age Group",
       y="odds ratio")

```

This is an interesting graph: young people (under 35) tend to have good general
health indicators regardless of their smoking habits. This changes as people start to age
past that threshold. The next two age groups show a larger association between smoking and
worse health than the oldest group. Is this suggesting that smoking makes the effects of aging start sooner? However once people reach old age, their health gets worse even if they don't smoke.


## Contingency tables for electronic nicotine product

### Diseases Diagnosis

```{r}
# diseases association with electronic nicotine product
for(variable in health_disease_variables){
  if("1 YES" %in% levels(small_df[[variable]])){
  print(titles_health_disease[variable])
  print("Contingency table")
  print(cont_tables(small_df, "SDENICPROD", variable)%>% round(digits=3))
  print("testing hypothesis of no association")
  print(cont_tables(small_df, "SDENICPROD", variable,F)%>% chisq.test(correct = F))
  print("------------")
  }

}
```
Association between usage of Electronic Nicotine product and diseases: analysis with conditional contingency tables and chi squared tests
Summary of key points:

- Asthma: strong association: who uses e cigs is more likely to have asthma

-Arthritis: strong association but in the opposite direction: who uses e-cigs has a lower rate of Arthritis. Probably because of confounding effect of age. Young people are less likely to have Arthritis, but are much more likely to use e cigs

-Lung Cancer: strong association, correct direction

-Cholesterol: strong association, but in opposite direction: need to control for age like arthritis

-Chronic Bronchitis: strong association, correct direction

-Diabetes: strong association, correct direction

-Emphysema: strong association, correct direction

-High Blood Pressure: strong association, but in opposite direction: need to control for age like arthritis

-Stroke: strong association, correct direction

```{r}

chisq_df_diseases = data.frame(diseases = health_disease_variables,
                               p_val_full_data= rep(NA, length(health_disease_variables)),
                               p_val_65plus_data= rep(NA, length(health_disease_variables)),
                               p_val_45_64_data= rep(NA, length(health_disease_variables)))

for(i in 1:nrow(chisq_df_diseases)){
  variable = chisq_df_diseases[i,"diseases"]
  test_full = cont_tables(small_df,"SDENICPROD",variable, F) %>%
    chisq.test(correct = F)
  test_45_64 = cont_tables_age(small_df,"SDENICPROD",variable,"45-64",F) %>%
    chisq.test(correct = F)
  test_65plus = cont_tables_age(small_df,"SDENICPROD",variable,"65+",F) %>%
    chisq.test(correct = F)
  chisq_df_diseases[i,"p_val_full_data"] = test_full$p.val
  chisq_df_diseases[i,"p_val_45_64_data"] = test_45_64$p.val
  chisq_df_diseases[i,"p_val_65plus_data"] = test_65plus$p.val
  
}

chisq_df_diseases = chisq_df_diseases %>%
  rename(full_data = p_val_full_data,
         age_65plus = p_val_65plus_data,
         age_45_64 = p_val_45_64_data) %>%
  mutate(diseases = titles_health_disease[diseases]) %>%
  pivot_longer(cols=c("full_data","age_65plus","age_45_64"))

ggplot(chisq_df_diseases, aes(x = name, y = value)) +
  geom_col() + geom_hline(aes(yintercept = 0.05), col = "red") +
  facet_wrap(~diseases, scales = "free") + 
  labs(title="Testing hypothesis of no association between 
Electronic Nicotine Product usage and various diseases",
       subtitle = "P-value of Chi squared test, controlling for age groups",
       x = "", y ="")+
  scale_x_discrete(labels = c("full_data" = "All patients",
                              "age_65plus" = "ages 65 plus" ,
                              "age_45_64" = "ages 45-64")) +
  theme_minimal() + theme(axis.text.x = element_text(size = 7))
```

```{r}
#odds ratio
#odds of diseases for users/ odds of diseases for non users

or_data_all = expand.grid(diseases = health_disease_variables,
                      age = "all",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_all)){
  var_of_interest = as.character(or_data_all$diseases[i])
  or = small_df %>%
    select(SDENICPROD,var_of_interest)%>%
    filter(SDENICPROD %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_all[i,"estimate"] = or$measure[2,"estimate"]
  or_data_all[i,"lower"] = or$measure[2,"lower"]
  or_data_all[i,"upper"] = or$measure[2,"upper"]
}

or_data_45_64 = expand.grid(diseases = health_disease_variables,
                      age = "45_64",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_45_64)){
  var_of_interest = as.character(or_data_45_64$diseases[i])
  or = small_df %>% filter(age_group == "45-64") %>%
    select(SDENICPROD,var_of_interest)%>%
    filter(SDENICPROD %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_45_64[i,"estimate"] = or$measure[2,"estimate"]
  or_data_45_64[i,"lower"] = or$measure[2,"lower"]
  or_data_45_64[i,"upper"] = or$measure[2,"upper"]
}


or_data_65plus = expand.grid(diseases = health_disease_variables,
                      age = "65plus",estimate = NA,
                      lower = NA, upper = NA)

for(i in 1:nrow(or_data_65plus)){
  var_of_interest = as.character(or_data_65plus$diseases[i])
  or = small_df %>% filter(age_group == "65+") %>%
    select(SDENICPROD,var_of_interest)%>%
    filter(SDENICPROD %in% c("1 YES", "2 NO"),
           .data[[var_of_interest]] %in% c("1 YES", "2 NO")) %>%
    mutate(across(c(1,2), factor)) %>%
    table() %>% epitools::oddsratio(method = "wald", correction = F)
  or_data_65plus[i,"estimate"] = or$measure[2,"estimate"]
  or_data_65plus[i,"lower"] = or$measure[2,"lower"]
  or_data_65plus[i,"upper"] = or$measure[2,"upper"]
}

or_data = rbind(or_data_all,or_data_45_64,or_data_65plus)

or_data %>% mutate(diseases = titles_health_disease[diseases]) %>%
  ggplot(aes(x = age)) + geom_point(aes(y = estimate)) +
  geom_segment(aes(x = age, xend = age, y = lower, yend = upper))+
  geom_hline(aes(yintercept  = 1), col = "red")+
  facet_wrap(~diseases, scales = "free") +
  labs(title="Odds Ratio of Disease Diagnosis for Users and Non-Users of E-Nic. Prods",
       subtitle = "95% confidence intervals for different age groups",
       x = "", y ="")+
  scale_x_discrete(labels = c("all" = "All",
                              "65plus" = "65 and over" ,
                              "45_64" = "45-64")) +
  theme_minimal() + theme(axis.text.x = element_text(size = 7))

```


The graph is clearly showing what we expected: if we don't control for age,
the association between diagnosis and usage of E-nic. products is opposite.
However, when we look at individual age groups the direction changes. We found
many cases of Simpson's paradox: Arthritis, Blood pressure, cholesterol, and Stroke.


### General Health 


```{r}


#ADGENH42
table_multi_cat(small_df, "SDENICPROD", "ADGENH42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADGENH42)) +
  labs(title = "Contingency table: Electronic nicotine product usage and General health", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Users",
                              "2 NO" = "Non users"))
#RTHLTH31
table_multi_cat(small_df, "SDENICPROD", "RTHLTH31") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = RTHLTH31)) +
  labs(title = "Contingency table: Electronic nicotine product usage and Perceived Health Status", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "Users",
                              "2 NO" = "Non Users"))

#ADENGY42
table_multi_cat(small_df, "SDENICPROD", "ADENGY42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADENGY42)) +
  labs(subtitle = "During the past 4 weeks, how many people had a lot of energy",
       title = "Contingency table: Electronic nicotine product usage and energy", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))

#WLKLIM53

table_multi_cat(small_df, "SDENICPROD", "WLKLIM53") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = WLKLIM53)) +
  labs(title = "Electronic nicotine product usage and Limitation in Physical Functioning",
       subtitle = "Contingency table with conditional probability",
       x = "",
       y="frequency", fill="Walking Limitation") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))+
  scale_fill_discrete(labels = c("Yes", "No"))

```


```{r}
# odds ratio: E-nic usage and walking limitations in different age groups

table_multi_cat_control(small_df, "SDENICPROD", "WLKLIM53",F) %>% as_tibble() %>%
  filter(age_group != "0-18") %>%
  group_by(age_group) %>%
  summarise(or_estimate = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"estimate"],
            or_lower = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"lower"],
            or_upper = epitools::oddsratio(n,method = "wald",
                                              correction = F)$measure[2,"upper"]) %>%
  mutate(age_group = factor(age_group)) %>%
  ggplot() +
  geom_point(aes(x = age_group, y = or_estimate)) +
  geom_segment(aes(x = age_group,xend=age_group,
                   y = or_lower, yend=or_upper))+
  geom_hline(aes(yintercept =1), col = "red") +
  labs(title = "E-nicotine usage and Limitation in Physical Functioning across different ages",
       subtitle = "95% confidence intervals for odds ratio",
       x = "Age Group",
       y="odds ratio")
```




### Mental health
```{r}

# "MNHLTH31"
table_multi_cat(small_df, "SDENICPROD", "MNHLTH31") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = MNHLTH31)) +
  labs(title = "electronic nicotine product usage and Perceived Mental Health status", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))


#"ADPCFL42"
table_multi_cat(small_df, "SDENICPROD", "ADPCFL42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADPCFL42)) +
  labs(subtitle = "During the past 4 weeks, how often people felt calm and peaceful",
       title = "electronic nicotine product usage and feeling peaceful", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))


#"ADDPRS42"
table_multi_cat(small_df, "SDENICPROD", "ADDPRS42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADDPRS42)) +
  labs(subtitle = "How many days in the past 2 weeks people felt down/depressed/hopeless",
       title = "Contingency table: electronic nicotine product usage and feeling down", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))

# "ADHOPE42"
table_multi_cat(small_df, "SDENICPROD", "ADHOPE42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADHOPE42)) +
  labs(subtitle = "During the past 30 days, how often people felt hopeless",
       title = "electronic nicotine product usage and feeling hopeless", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))

# "ADNERV42"
table_multi_cat(small_df, "SDENICPROD", "ADNERV42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADNERV42)) +
  labs(subtitle = "During the past 30 days, how often people felt nervous",
       title = "electronic nicotine product usage and feeling nervous", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))

# "ADSAD42" 
table_multi_cat(small_df, "SDENICPROD", "ADSAD42") %>% as_tibble() %>%
  ggplot() + geom_col(aes(x = SDENICPROD, y = n, fill = ADSAD42)) +
  labs(subtitle = "During the past 30 days, how often people felt so sad that nothing could cheer the person up",
       title = "electronic nicotine product usage and feeling sad", x = "",
       y="frequency", fill="") +
  scale_x_discrete(labels = c("1 YES" = "users",
                              "2 NO" = "Non users"))



```


```{r}
# mental health controlling for age

# looking at how the contingency table for perceived mental health and e-nic. usage
# is different in the different age groups
age_18_24 = table_multi_cat_age(small_df, "SDENICPROD", "MNHLTH31", "18-24") %>% as_tibble %>%
  mutate(age = "18-24")
age_25_34 = table_multi_cat_age(small_df, "SDENICPROD", "MNHLTH31", "25-34") %>% as_tibble %>%
  mutate(age = "25-34")
age_35_44 = table_multi_cat_age(small_df, "SDENICPROD", "MNHLTH31", "35-44") %>% as_tibble %>%
  mutate(age = "35-44")
age_45_64 = table_multi_cat_age(small_df, "SDENICPROD", "MNHLTH31", "45-64") %>% as_tibble %>%
  mutate(age = "45-64")
age_65plus = table_multi_cat_age(small_df, "SDENICPROD", "MNHLTH31", "65+") %>% as_tibble %>%
  mutate(age = "65+")

all_tables = rbind(age_18_24,age_25_34,age_35_44,age_45_64,age_65plus)

all_tables %>% mutate(age = factor(age)) %>%
  ggplot(aes(x = n, fill = MNHLTH31, y = SDENICPROD)) +
  geom_col(orientation = "y") +
  facet_grid(rows = vars(age))+
  labs(title = "Perceived Mental Health and E-Nic. in different age groups", y = "",
       subtitle = "Contingency tables with conditional probability", x="frequency", fill="Perceived Mental Health") +
  scale_y_discrete(labels = c("1 YES" = "Users",
                              "2 NO" = "Non-Users"))+
  theme(strip.text.y = element_text(angle = 0))

```

Summary:

the general health of e-nicotine products users is the not much lower than that of non users. However there is a bigger gap in the mental health of the two groups: in the data we see that non users tend to have higher values of good mental health

# Smoking Cigarettes

Now we started to fit some models for Smoking and E-Smoking. We decided to analyse the two variables in distinct ways because there is a quite different demographic
makeup in the two groups of users. As we have seen in the beginning, users of electronic nicotine products tend to be very young. While smokers tend to be middle aged.
We decide to start with the smoking predictor. We want to keep only *AGE*, *SEX* and *AGEGROUP* as other predictors.

## Logistic regression for physical health

```{r}
values_to_remove <- c("-15 CANNOT BE COMPUTED", "-8 DK", "-7 REFUSED", "-1 INAPPLICABLE")
small_df = small_df %>% mutate(AGEGROUP = age_group)
```


### Arthritis 

```{r}
filter_df <- small_df %>% select(ARTHDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$ARTHDX <- relevel(filter_df$ARTHDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(ARTHDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(ARTHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ARTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()

```

All our variables are significant.
Arthritis is characterized by a positive correlation with smoking (more pronounced in women), sex and age.

### Diabetes
```{r}
filter_df <- small_df %>% select(DIABDX_M18, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$DIABDX_M18 <- relevel(filter_df$DIABDX_M18, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(DIABDX_M18 ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(DIABDX_M18 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of DIABDX_M18 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  ylim(c(0, 0.6))

```

In this case, looking at smoking in general is not significant, but if we control for sex, in the female there is definitely a correlation.
Diabetes is characterized by a positive correlation with smoking (significant in women) and with age, and a negative one with being female.

### Emphysema
```{r}
filter_df <- small_df %>% select(EMPHDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$EMPHDX <- relevel(filter_df$EMPHDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(EMPHDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(EMPHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of EMPHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  ylim(c(0, 0.35))

```

All our variables are significant.
Emphysema is characterized by a positive correlation with smoking and age (more pronounced in smokers), and a negative one for being female.

### Stroke

```{r}
filter_df <- small_df %>% select(STRKDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$STRKDX <- relevel(filter_df$STRKDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(STRKDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(STRKDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of STRKDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  ylim(c(0, 0.4))

```

All our variables are significant, except for the interaction between smoking and sex.
Stroke is characterized by a positive correlation with smoking and age, and a negative one for being female.

### Lung Cancer 
```{r}
filter_df <- small_df %>% select(CALUNG, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CALUNG <- relevel(filter_df$CALUNG, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(CALUNG ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(CALUNG == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CALUNG by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  ylim(c(0, 0.35))

```

In this case, both age and interaction between smoking and sex seem to be not significant.
However we can observe that Lung Cancer is characterized by a positive correlation with both smoking and age, and this correlations are more pronounced for men.

### Asthma

```{r}
filter_df <- small_df %>% select(ASTHDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ASTHDX <- relevel(filter_df$ASTHDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ASTHDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithAsthma = sum(ASTHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ASTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```

Also in this case, looking at smoking in general is not significant, but if we look at the interaction between smoking and sex, there is definitely a correlation.
Asthma is quite particular, because is the only one that is characterized by a negative correlation with age. Also in this case we have a positive correlation with smoking (significant in female) and with sex.

### High Cholesterol
```{r}
filter_df <- small_df %>% select(CHOLDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHOLDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```
Also in this case, looking at smoking in general is not significant, as we see in the interaction with sex, in the female there is definitely a correlation.
High Cholesterol is characterized by a positive correlation with smoking (significant in women) and with age, and a negative one with being female.


### Chronic Bronchitis
```{r}
filter_df <- small_df %>% select(CHBRON31, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)


# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHBRON31 <- relevel(filter_df$CHBRON31, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHBRON31 ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithBronch = sum(CHBRON31 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithBronch/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHBRON31 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```

In this case, both age and interaction between smoking and sex seem to be not so significant (not at all in general and really low for the interaction).
However we can observe that Chronic Bronchitis is characterized by a positive correlation with both age and smoking (more pronunced a little bit more pronunced for female).

### High Blood Pressure
```{r}
filter_df <- small_df %>% select(HIBPDX, ADSMOK42, SEX, AGELAST) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(HIBPDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithPress = sum(HIBPDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of HIBPDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```

In this case, all our variables are significant.
High Blood Pressure is characterized by a positive correlation with smoking and with age, and a negative one with being female.

As we can say we obtained a lot of different results, both negative and positive,
but we can see that for some models there is a direct correlation with *AGE*. Also some plots are quite similar (like the one for Cholesterol and Blood pressure) So there could be some connection between those disease.
To prove this we can try if some physical diseases have some of connection.

#### Trying to see if Cholesterol and Blood pressure are correlated

```{r}
filter_df <- small_df %>% select(CHOLDX, HIBPDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ HIBPDX * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, HIBPDX) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), HIBPDX = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = HIBPDX)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of High Cholesterol by Age, High Blood Pressure, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```

As we can see, there is definitely a correlation.

## Multilogit regression for Mental Health

Now to evaluate the mental health status we need to change the type of the regression. In the first part we used the Logistic Regression, but for this part we need to use the Multinomial Logistic Regression. MLR is a classification method that modify logistic regression to multiclass problems, i.e. with more than two possible discrete outcomes (I promise, is just a case that is very similar to the Wikipedia description). 

### Perceived Mental Health Status 

```{r}
filter_df <-small_df %>% select(MNHLTH31, ADSMOK42, SEX, AGELAST) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$MNHLTH31 <- relevel(filter_df$MNHLTH31, ref = "1 EXCELLENT")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")
filter_df$MNHLTH31 = ordered(filter_df$MNHLTH31)
```


```{r}
fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) +
  title("Mental Health by Age") + 
  grid()
legend("left",legend = sort(unique(filter_df$MNHLTH31)), col = 1:5, lty = 1:5, lwd = 2, cex = 0.6)
```

Here we can see the general distribution of the Perceived Mental Health Status for every age. As we see, the majority of the people are distributed between the 3 best cases, with the "very good" one being the most frequent.

```{r}
null <-  vglm(MNHLTH31 ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)

pchisq(deviance(null)-deviance(fit), df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

Then we fitted the model with also SEX

```{r}
fit <- vglm(MNHLTH31 ~ ADSMOK42 + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
summary(fit)
```

Oh no! There is a problem in our regression, what is that? The Hauck-Donner effect?
It reminds me a name of a music instrument brand...never mind.

The Hauck-Donner effect is a problem that can occur if we use small data-frame, indicates that
the significance of our model can be false. But how can we solve it? Don't worry, is very simple.

We bootstrapped the original data-frame for 100 times (better more but our pc are not so
powerful).

```{r}
data <- filter_df
formula <- MNHLTH31 ~ ADSMOK42 + SEX + AGELAST

fit_model <- function(data, indices) {
  boot_data <- data[indices, ]
  model <- vglm(formula,
             family = cumulative(parallel = TRUE),
             data = boot_data)
  return(coef(model))
}

set.seed(123)
bootstrap_results <- boot(data = data, statistic = fit_model, R = 100)

bootstrap_results

boot.ci(bootstrap_results, type = "basic")
```

Fortunately the bootstrap confirm the robustness of our model. 

#### Difference between smokers and non smokers

Then we compared the smokers and non smokers filtering the dataset for this variable and fitting 2 models.

```{r}
smk_df = filter_df %>% filter(ADSMOK42 == "1 YES")
n_smk_df = filter_df %>% filter(ADSMOK42 == "2 NO")
```


```{r}
# For smokers
fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.08))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST") 
grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.69))
mtext("Perceived Mental Health Status for Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```


```{r}
# For non smokers
fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = n_smk_df)

df_pred = data.frame(AGELAST = seq(min(n_smk_df$AGELAST), max(n_smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.14))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.37))
mtext("Perceived Mental Health Status for Non-Smokers", outer = TRUE, cex = 1.5, line = -3)
```

From this 2 groups of plots we see that non-smokers tend to have better Perceived Mental Health. The majority of the non-smoking population perceives their mental health as "very good," with the best category ("excellent," shown in black) being the second most prevalent up to age 56. In contrast, among smokers, the most common perception is "good," followed by "very good." "Excellent" ranks only third.

## General Health Smoking

Here, we have performed the same analysis for the "General Health" variable.

```{r}
filter_df <-small_df %>% select(ADGENH42, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$ADGENH42 <- relevel(filter_df$ADGENH42, ref = "1 EXCELLENT")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(ADGENH42 ~ AGELAST , data = filter_df, family = multinomial)

# summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) 
title("General Health by Age")  
grid()
legend("bottomleft",legend = sort(unique(filter_df$ADGENH42)), col = 1:5, lty = 1:5, lwd = 2, cex = 0.6, inset = c(0, 0.25))
```

The General Health plot is quite different from the previous one, as we see that the effect of age is stronger. In this case we see a strong decreasing in the best cases (Very good and Excellent) and the increase of the others.

```{r}
confint(fit)

null = vglm(ADGENH42 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

Than we added the sex variable also in this case and we did some plots

```{r}
filter_df$ADGENH42 = ordered(filter_df$ADGENH42)
fit <- vglm(ADGENH42 ~ ADSMOK42 + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
summary(fit)
```

```{r}
data <- filter_df
formula <- ADGENH42 ~ ADSMOK42 + SEX + AGELAST

fit_model <- function(data, indices) {
  boot_data <- data[indices, ]
  model <- vglm(formula,
             family = cumulative(parallel = TRUE),
             data = boot_data)
  return(coef(model))
}

set.seed(123)
bootstrap_results <- boot(data = data, statistic = fit_model, R = 100)

bootstrap_results

boot.ci(bootstrap_results, type = "basic")
```

Also in this case we checked if our model was robust before splitting in smokers and non-smokers, and it was.

```{r}
smk_df = filter_df %>% filter(ADSMOK42 == "1 YES")
n_smk_df = filter_df %>% filter(ADSMOK42 == "2 NO")
```

```{r}
# For smokers
fit <- vglm(ADGENH42 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
  grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.4))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
  grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.08))
mtext("General Health Status for Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```

```{r}
# For not smokers
fit <- vglm(ADGENH42 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = n_smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
  grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.4))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
  grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.08))
mtext("General Health Status for NOT Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```

Also in this case we see that non-smokers tend to have better General Health. Non smokers are starting from higher General Health categories, and are inverting with worst ones later in the years respect to smokers. We can observe that as years pass, the most of the smoker are distributing between the "Good" and "Fair" categories, with also the "Poor" one surpassing the "Excellent" one. For non smokers this inversion never happens, and later in the years, the most of the people are still distributing between the "Very Good" and "Good" categories.

# E-Smoking

Form now on we will repeat the same steps for the E-smoking

## Logistic regression for physical health

```{r}
values_to_remove <- c("-15 CANNOT BE COMPUTED", "-8 DK", "-7 REFUSED", "-1 INAPPLICABLE")
```


### Stroke  

```{r}
filter_df <- small_df %>% select(STRKDX , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$STRKDX  <- relevel(filter_df$STRKDX , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(STRKDX  ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithStroke = sum(STRKDX  == "1 YES"), tot = n()) %>%
  mutate(frequency = WithStroke/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of STRKDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()

```

### Asthma

```{r}
filter_df <- small_df %>% select(ASTHDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ASTHDX <- relevel(filter_df$ASTHDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ASTHDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithAsthma = sum(ASTHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ASTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```


### Arthritis

```{r}
filter_df <- small_df %>% select(ARTHDX , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ARTHDX  <- relevel(filter_df$ARTHDX , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ARTHDX  ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithAsthma = sum(ARTHDX  == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ARTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### High Cholesterol
```{r}
filter_df <- small_df %>% select(CHOLDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHOLDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### Diabetes
```{r}
filter_df <- small_df %>% select(DIABDX_M18 , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)


# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$DIABDX_M18 <- relevel(filter_df$DIABDX_M18 , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(DIABDX_M18 ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithBronch = sum(DIABDX_M18 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithBronch/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of DIABDX_M18 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```



### High Blood Pressure
```{r}
filter_df <- small_df %>% select(HIBPDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(HIBPDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithPress = sum(HIBPDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of HIBPDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### Lung cancer

```{r}
filter_df <- small_df %>% select(CALUNG, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CALUNG <- relevel(filter_df$CALUNG, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CALUNG ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithPress = sum(CALUNG == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CALUNG by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### Bronchitis

```{r}
filter_df <- small_df %>% select(CHBRON31, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHBRON31 <- relevel(filter_df$CHBRON31, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHBRON31 ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithPress = sum(CHBRON31 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHBRON31 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```


### Emphysema

```{r}
filter_df <- small_df %>% select(EMPHDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$EMPHDX <- relevel(filter_df$EMPHDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(EMPHDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithPress = sum(EMPHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of EMPHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

To sum up all the results we can see above, even if the results are based on a different section of the population (because as we saw above cigarettes and electronic smoking devices are distributed in different ways), the results are pretty similar.
With respect to cigarettes, the difference between smokers and non smokers are more accentuated in some cases, but most times are a little bit less present. That's because the data in our possession about e-smokers are more distributed around younger ages, in which usually people tends to stay better regardless. 
Even with this specification, the variable is still very significant in most of our models, signalling that even if you smoke electronic cigarettes, not smoking at all tends to be increase the probabilities of staying better.

## Multilogit regression for Mental Health

### Perceived Mental Health Status 

```{r}
filter_df <-small_df %>% select(MNHLTH31, SDENICPROD, SEX, AGELAST) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$MNHLTH31 <- relevel(filter_df$MNHLTH31, ref = "1 EXCELLENT")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")
```


```{r}
filter_df$MNHLTH31 = ordered(filter_df$MNHLTH31)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)

matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2)
title("Mental Health by Age")  
grid()
legend("left",legend = sort(unique(filter_df$MNHLTH31)), col = 1:5, lty = 1:5, lwd = 2, cex = 0.6)
```

```{r}
null <-  vglm(MNHLTH31 ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)

pchisq(deviance(null)-deviance(fit), df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

```{r}
fit <- vglm(MNHLTH31 ~ SDENICPROD + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
summary(fit)
```
```{r}
data <- filter_df
formula <- MNHLTH31  ~ SDENICPROD  + SEX + AGELAST

fit_model <- function(data, indices) {
  boot_data <- data[indices, ]
  model <- vglm(formula,
             family = cumulative(parallel = TRUE),
             data = boot_data)
  return(coef(model))
}

set.seed(123)
bootstrap_results <- boot(data = data, statistic = fit_model, R = 100)

bootstrap_results

boot.ci(bootstrap_results, type = "basic")
```

#### Difference between smokers and non smokers

```{r}
smk_df = filter_df %>% filter(SDENICPROD == "1 YES")
n_smk_df = filter_df %>% filter(SDENICPROD == "2 NO")
```


```{r}
# For smokers
fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.5))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST") 
grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.15))
mtext("Perceived Mental Health Status for E-Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```


```{r}
# For non smokers
fit <- vglm(MNHLTH31 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = n_smk_df)

df_pred = data.frame(AGELAST = seq(min(n_smk_df$AGELAST), max(n_smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.14))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.37))
mtext("Perceived Mental Health Status for NOT E-Smokers", outer = TRUE, cex = 1.5, line = -3)
```



## General Health E - Smoking
```{r}
filter_df <-small_df %>% select(ADGENH42, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$ADGENH42 <- relevel(filter_df$ADGENH42, ref = "1 EXCELLENT")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(ADGENH42 ~ AGELAST , data = filter_df, family = multinomial)

# summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2)
  title("General Health by Age") 
  grid()
legend("bottomleft",legend = unique(filter_df$ADGENH42), col = 1:5, lty = 1:5, lwd = 2, cex = 0.6, inset = c(0, 0.25))
```




```{r}
confint(fit)

null = vglm(ADGENH42 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

```{r}
filter_df$ADGENH42 = ordered(filter_df$ADGENH42)

fit <- vglm(ADGENH42 ~ SDENICPROD + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
summary(fit)
```
```{r}
data <- filter_df
formula <- ADGENH42 ~ SDENICPROD + SEX + AGELAST

fit_model <- function(data, indices) {
  boot_data <- data[indices, ]
  model <- vglm(formula,
             family = cumulative(parallel = TRUE),
             data = boot_data)
  return(coef(model))
}

set.seed(123)
bootstrap_results <- boot(data = data, statistic = fit_model, R = 100)

bootstrap_results

boot.ci(bootstrap_results, type = "basic")
```



### Difference btween smokers and non smokers

```{r}
smk_df = filter_df %>% filter(SDENICPROD == "1 YES")
n_smk_df = filter_df %>% filter(SDENICPROD == "2 NO")
```

```{r}
# For smokers
fit <- vglm(ADGENH42 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")
  grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.25))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST") 
  grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.08))
mtext("General Health Status for E-Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```

```{r}
# For not smokers
fit <- vglm(ADGENH42 ~ AGELAST,
             family = cumulative(parallel = TRUE),
             data = n_smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), by = 1))
preds = predict(fit, df_pred) 
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST")+
  grid()
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.3))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST") 
  grid()
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.6, xpd = TRUE,
       inset = c(0, 0.08))
mtext("General Health Status for NOT E-Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```

Also in this case the results for Perceived Mental Health and General Health are quite similar to those previously discussed. A difference we can point out is a general improvement in perceived mental health for E-Smokers (compared to cigarette smokers) and a general worsening in general health for E-Smokers. One interpretation of this could be that some people are switching to E-smoking because of poor health, and what we are seeing is due to external factors or previous habits. Unfortunately, we do not have access to this type of data in this dataset, so we will limit our discussion to what we are observing.

# Conclusions

Our study investigates the negative health effects associated with smoking, focusing on both physical and mental health outcomes. Using the 2021 Medical Expenditure Panel Survey Household Component data, which includes responses from 15,000 households in the United States, we compared the health impacts of smoking with those of using electronic nicotine products (e-nic products). Our analysis reveals that overall general and mental health is better among non-smokers compared to both smokers and e-nic product users. 

However, the data set's limited size constrains the robustness of our findings. Larger and more comprehensive data would likely provide more definitive insights into these health relationships. Additionally, our understanding of the health effects associated with e-nic products remains incomplete due to the relatively new nature of these products and the insufficient data available in our current dataset. Future research should aim to gather more extensive data on e-nic product usage to better assess its impact on mental and general health. 

Despite these limitations, our findings contribute to the growing body of evidence highlighting the adverse health effects of smoking and underscore the need for continued public health efforts to reduce smoking rates and further investigate the health implications of e-nic products.

