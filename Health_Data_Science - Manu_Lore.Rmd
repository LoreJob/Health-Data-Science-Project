---
title: Health Data Science
output:
  html_document:
    fig_caption: yes
    theme: flatly #sandstone #spacelab #flatly
    highlight: pygments
    code_folding: show
    toc: TRUE
    toc_depth: 2
    number_sections: TRUE
    toc_float:
      smooth_scroll: FALSE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
# Only need to run these once:
#  install.packages("foreign")  
#  install.packages("tidyverse")
#  install.packages("readr")
#  install.packages("readxl")
#  install.packages("haven")
#  install.packages("survey")
#  install.packages("remotes")


# Run these every time you re-start R:
  library(foreign)
  library(tidyverse)
  library(readr)
  library(readxl)
  library(haven)
  library(survey)
  library(remotes)
  library(jtools)
  library(VGAM)
#  library(MEPS)
```

# 1 - First Paragraph

**For the project i offer to consider the following topic: 'Young Adults Aged 18-24 Who Had Ever Used an Electronic Nicotine have poor general health and more likely to have asthma diagnoses'**

Comment by Giuseppe:

(I think this topic is too specific and the dataset will not allow us to explore it deeply.
We would need to have information on older persons that have asthma and their smoking habits when they were young)

I propose we chose a more general topic:

<hr>

**The central question we want to answer is: what are the negative effects of smoking?**

We will look at the association between smoking and health related issues. We 
will also look at some mental health indicators and how they relate to smoking
habits.

<hr>


*Here is info about characteristics:* <https://meps.ahrq.gov/data_files/publications/st554/stat554.shtml>

*Here is questionary report:* <https://meps.ahrq.gov/survey_comp/hc_survey/paper_quest/2021/2021_SHE_SAQ.pdf>

*Codebook:* <https://meps.ahrq.gov/data_stats/download_data/pufs/h233/h233cb.pdf>


```{r}
# the dataset is in the github repo, we don't need to download it every time
h233 <- read_dta("h233.dta")
head(h233)
```

Our main explanatory variables:

ADSMOK42: currently smokes

OFTSMK53: How Oftn Smoke Cigarettes (>17) - RD 5/3

ADNSMK42 - If ADSMOK42 = 1, doctor advised you to quit smoking

SDENICPROD: used electronic nicotine product

ADDPRS42: felt down/depressed

ADGENH42: health in general

ADENGY42: had a lot of energy

ADHOPE42: how often felt hopeless

ADNERV42: how often felt nervous

ADPCFL42: felt calm/peaceful

ADSAD42: how often felt sad

AGELAST: person age

ASTHDX: asthma diagnosis

ARTHDX:  had ever been diagnosed with arthritis

CALUNG: lung cancer diagnosed

CHOLDX: high cholesterol diagnosis

CHBRON31: if the person (aged 18 or older) has had chronic bronchitis in the last 12 months

DIABDX_M18: diabetes diagnosis

EMPHDX: Emphysema diagnosis

EMPST31: employment status

FAMINC21: family income

HIBPDX: whether the person had ever been diagnosed as having high blood pressure (other than during pregnancy)

MNHLTH31: perceived mental health status

MARRY21X: marital status

TTLP21X: person total income

OHRTDX: asked if the person had ever been diagnosed with any other kind of heart disease or condition

OHRTTYPE: specify other heart diseases or conditions

RTHLTH31: perceived health status

REGION21:indicate the Census region for the RU. (A Reporting Unit (RU) is a person or group of persons in the sampled DU who are related by blood, marriage, adoption, or other family association. Each RU was interviewed as a single entity for MEPS.)

WLKLIM53: limitation in physical functioning

SDCOMPAN: feel lack of companionship

STRKDX: asked if the person (aged 18 or older) had ever been diagnosed as having had a stroke or transient ischemic attack 

SDLEFTOUT: feel left out

SDLIFE: satisfied with life

SDHOME - How satisfied with house/apartment where person lives

SDISOL - How often feel isolated from others

SEX: gender

SDMEDCARE - Rate neighborhood availability of places to get medical care

SDHLTHFOOD - Rate neighborhood availability of places to buy healthy food

SDHMDEPR - When under 18 years of age, lived with someone who was depressed, mentally ill, or suicidal

SDHMALC - When under 18 years of age, lived with a problem drinker or alcoholic

SDHMDRG - When under 18 years of age, lived with someone who used illegal street drugs or abused prescription medication

SDHMDIV - Parents separated or divorced

SDHMBEAT - How often did parents or adults in home slap, hit, kick, punch, or beat each other up

SDHURTCHLD - How often did parents or adults in home hit, beat, kick, or physically hurt person

FTSTU21X: student status

RACEV2X:race


## 46 variables 
#Variables of interest: ADSMOK42, ADNSMK42, SDENICPROD

#Demograpfical variables: AGELAST, REGION21, SEX, RACEV2X, MARRY21X, FTSTU21X, TTLP21X, FAMINC21, EMPST31

#Mental health: ADDPRS42, ADHOPE42, ADNERV42, ADPCFL42, ADSAD42, MNHLTH31

#General health: ADGENH42, ADENGY42, RTHLTH31, WLKLIM53

#Health deseases: ASTHDX, ARTHDX, CALUNG, CHOLDX, CHBRON31, DIABDX_M18, EMPHDX, HIBPDX, OHRTDX, OHRTTYPE, STRKDX

#The Social Determinants of Health Survey (SDOH) includes questions about the social determinants of health, such as housing, financial well-being, food security, social support, discrimination, and physical and sexual violence.: SDLIFE, SDHOME, SDMEDCARE, SDHLTHFOOD, SDCOMPAN, SDLEFTOUT, SDISOL, SDHMDEPR, SDHMALC, SDHMDRG, SDHMDIV, SDHMBEAT, SDHURTCHLD

```{r}
vars_to_keep = c("ADSMOK42", "OFTSMK53","SDENICPROD","ADDPRS42","ADGENH42",
                 "ADENGY42","ADHOPE42","ADNERV42","ADPCFL42","ADSAD42",
                 "AGELAST","ASTHDX","CALUNG","CHOLDX","DIABDX_M18","EMPHDX",
                 "FAMINC21","HIBPDX","MNHLTH31","RTHLTH31","TTLP21X",
                 "WLKLIM53","SDCOMPAN","SDLEFTOUT","SDLIFE", 'REGION21', 'RACEV2X', 
                 'FTSTU21X', 'SEX','STRKDX','HIBPDX', 'MARRY21X','CHBRON31' ,'CANCERDX', 
                 'ARTHDX', 'ADNSMK42', 'SDHOME', 'SDMEDCARE','SDHLTHFOOD', 'SDISOL',
                 'SDHMDEPR','SDHMALC','SDHMDRG', 'SDHMDIV', 'SDHMBEAT', 'SDHURTCHLD', 'EMPST31')

small_df = h233 %>% select(all_of(vars_to_keep)) %>% as_factor()
#turning the variables into factors

small_df = small_df %>% mutate(AGEGROUP = cut(AGELAST,
                                    breaks = c(-Inf,18, 25, 30, 35, 40, 45, 50, 55, 60, 65, Inf),
                  labels = c("0-18","18-24", "25-29", "30-34", "35-39", "40-44", "45-49", "50-54","55-59", "60-64", "65+"),
                  right = FALSE))
#adding a new variable to break into age groups

small_df %>% summary()


```

# Smoking Cigarettes

## Logistic regression for physical health

```{r}
values_to_remove <- c("-15 CANNOT BE COMPUTED", "-8 DK", "-7 REFUSED", "-1 INAPPLICABLE")
```


### Lung Cancer 

```{r}
filter_df <- small_df %>% select(CALUNG, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CALUNG <- relevel(filter_df$CALUNG, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(CALUNG ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```



```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithCancer = sum(CALUNG == "1 YES"), tot = n()) %>%
  mutate(frequency = WithCancer/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CALUNG by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  ylim(c(0, 0.35))

```



### Asthma

```{r}
filter_df <- small_df %>% select(ASTHDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ASTHDX <- relevel(filter_df$ASTHDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ASTHDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, ADSMOK42) %>% summarise(WithAsthma = sum(ASTHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ASTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```




### High Cholesterol (need to discuss)
```{r}
filter_df <- small_df %>% select(CHOLDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```


```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHOLDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### Chronic Bronchitis
```{r}
filter_df <- small_df %>% select(CHBRON31, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)


# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHBRON31 <- relevel(filter_df$CHBRON31, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHBRON31 ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithBronch = sum(CHBRON31 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithBronch/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHBRON31 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```



### High Blood Pressure
```{r}
filter_df <- small_df %>% select(HIBPDX, ADSMOK42, SEX, AGELAST) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(HIBPDX ~ ADSMOK42 * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, ADSMOK42) %>% summarise(WithPress = sum(HIBPDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = ADSMOK42)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of HIBPDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```

#### Trying to see if Colesterol and Blood pressure are correlated

```{r}
filter_df <- small_df %>% select(CHOLDX, HIBPDX, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ HIBPDX * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, HIBPDX) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), HIBPDX = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = HIBPDX)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of High Cholesterol by Age, High Blood Pressure, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()+
  theme(plot.title = element_text(hjust = 0.5))
```


## Multilogit regression for Mental Health

### Perceived Mental Health Status 

```{r}
filter_df <-small_df %>% select(MNHLTH31, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$MNHLTH31 <- relevel(filter_df$MNHLTH31, ref = "1 EXCELLENT")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(MNHLTH31 ~ AGELAST , data = filter_df, family = multinomial)

summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) 
legend("topleft",legend = unique(filter_df$MNHLTH31), col = 1:5, lty = 1:5, lwd = 2)
```

```{r}
confint(fit)

null = vglm(MNHLTH31 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

```{r}
filter_df$mental = ordered(filter_df$MNHLTH31) 

library(VGAM)
# parallel = TRUE imposes proportional odds structure
# 2 intercepts for 3 y categories 
fit <-  vglm(mental ~ AGELAST + ADSMOK42,
             family = cumulative(parallel = TRUE),
             data = filter_df)

summary(fit)  # same effects for all 3 logits
```

```{r}
df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), ADSMOK42 = "2 NO")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```

```{r}
null <-  vglm(mental ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(null)-deviance(fit),
df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

```{r}
fit2 <-  vglm(mental ~ ADSMOK42 + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(null)-deviance(fit2),
df=df.residual(null)-df.residual(fit2), lower.tail=FALSE)

summary(fit2)
```


```{r}
df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), ADSMOK42 = "2 NO", SEX = "2 FEMALE")
preds = predict(fit2, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.8, xpd = TRUE,
       inset = c(0, 0.12))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit2, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.8, xpd = TRUE,
       inset = c(0, 0.32))

par(mar = c(5, 4, 4, 8) + 0.1)
```

#### Difference between smokers and non smokers

```{r}
smk_df = filter_df %>% filter(ADSMOK42 == "1 YES")
n_smk_df = filter_df %>% filter(ADSMOK42 == "2 NO")
```


```{r}
# For smokers
fit <- vglm(mental ~ SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = smk_df)

df_pred = data.frame(AGELAST = seq(min(smk_df$AGELAST), max(smk_df$AGELAST), l = 50), SEX = "2 FEMALE")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.8, xpd = TRUE,
       inset = c(0, 0.4))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.7, xpd = TRUE,
       inset = c(0, 0.08))
mtext("Perceived Mental Health Status for Smokers", outer = TRUE, cex = 1.5, line = -3.5)
```


```{r}
# For non smokers
fit <- vglm(mental ~ SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = n_smk_df)

df_pred = data.frame(AGELAST = seq(min(n_smk_df$AGELAST), max(n_smk_df$AGELAST), l = 50), SEX = "2 FEMALE")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1, cex = 0.8, xpd = TRUE,
       inset = c(0, 0.14))
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1, cex = 0.7, xpd = TRUE,
       inset = c(0, 0.37))
mtext("Perceived Mental Health Status for Non-Smokers", outer = TRUE, cex = 1.5, line = -3)
```



## General Health Smoking
```{r}
filter_df <-small_df %>% select(ADGENH42, ADSMOK42, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$ADGENH42 <- relevel(filter_df$ADGENH42, ref = "1 EXCELLENT")
filter_df$ADSMOK42 <- relevel(filter_df$ADSMOK42, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(ADGENH42 ~ AGELAST , data = filter_df, family = multinomial)

# summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), ADSMOK42 = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) 
legend("topleft",legend = unique(filter_df$ADGENH42), col = 1:5, lty = 1:5, lwd = 2)
```

```{r}
confint(fit)

null = vglm(ADGENH42 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

```{r}
filter_df$mental = ordered(filter_df$ADGENH42) 

# parallel = TRUE imposes proportional odds structure
# 2 intercepts for 3 y categories 
fit <-  vglm(mental ~ AGELAST + ADSMOK42,
             family = cumulative(parallel = TRUE),
             data = filter_df)

summary(fit)  # same effects for all 3 logits
```

```{r}
df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), ADSMOK42 = "2 NO")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```

```{r}
null <-  vglm(mental ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(null)-deviance(fit),
df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

```{r}
fit2 <-  vglm(mental ~ ADSMOK42 + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(fit)-deviance(fit2),
df=df.residual(fit)-df.residual(fit2), lower.tail=FALSE)


df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), SDENICPROD = "2 NO", SEX = "2 FEMALE", ADSMOK42 = "2 NO")
preds = predict(fit2, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit2, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```





# E-Smoking

## Logistic regression for physical health

```{r}
values_to_remove <- c("-15 CANNOT BE COMPUTED", "-8 DK", "-7 REFUSED", "-1 INAPPLICABLE")
```


### Stroke  

```{r}
filter_df <- small_df %>% select(STRKDX , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$STRKDX  <- relevel(filter_df$STRKDX , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- glm(STRKDX  ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithStroke = sum(STRKDX  == "1 YES"), tot = n()) %>%
  mutate(frequency = WithStroke/tot)


# Creating the prediction data frame
prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of STRKDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()

```

### Asthma

```{r}
filter_df <- small_df %>% select(ASTHDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ASTHDX <- relevel(filter_df$ASTHDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ASTHDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithAsthma = sum(ASTHDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ASTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```


### Arthritis

```{r}
filter_df <- small_df %>% select(ARTHDX , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == c("18-24"))

filter_df$ARTHDX  <- relevel(filter_df$ARTHDX , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(ARTHDX  ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```


```{r}
data_point <- filter_df %>%  group_by(AGEGROUP,AGELAST, SEX, SDENICPROD) %>% summarise(WithAsthma = sum(ARTHDX  == "1 YES"), tot = n()) %>%
  mutate(frequency = WithAsthma/tot) 


prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 95))

# Predicting values using the model
prediction$Yval <- predict(fit, newdata = prediction, type = "response")


# Plotting the results
ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of ARTHDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### High Cholesterol
```{r}
filter_df <- small_df %>% select(CHOLDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$CHOLDX <- relevel(filter_df$CHOLDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(CHOLDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```


```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithChol = sum(CHOLDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithChol/tot) 

prediction <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


prediction$Yval <- predict(fit, newdata = prediction, type = "response")

ggplot(prediction, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of CHOLDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```

### Diabetes
```{r}
filter_df <- small_df %>% select(DIABDX_M18 , SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)


# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$DIABDX_M18 <- relevel(filter_df$DIABDX_M18 , ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(DIABDX_M18 ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithBronch = sum(DIABDX_M18 == "1 YES"), tot = n()) %>%
  mutate(frequency = WithBronch/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of DIABDX_M18 by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```



### High Blood Pressure
```{r}
filter_df <- small_df %>% select(HIBPDX, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$HIBPDX <- relevel(filter_df$HIBPDX, ref = "2 NO")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")


fit <- glm(HIBPDX ~ SDENICPROD * SEX + AGELAST, data = filter_df, family = "binomial")

summary(fit)
```

```{r}
data_point <- filter_df %>%  group_by(AGELAST, SEX, SDENICPROD) %>% summarise(WithPress = sum(HIBPDX == "1 YES"), tot = n()) %>%
  mutate(frequency = WithPress/tot) 

# Creating the prediction data frame
df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))

# Predicting values using the model
df_pred$Yval <- predict(fit, newdata = df_pred, type = "response")


# Plotting the results
ggplot(df_pred, aes(x = AGELAST, y = Yval, col = SDENICPROD)) + 
  geom_line() +
  geom_point(data = data_point, aes(y = frequency)) + 
  facet_wrap(~SEX) +
  labs(title = "Predicted Probability of HIBPDX by Age, Smoking Status, and Sex",
       x = "Age (AGELAST)",
       y = "Predicted Probability (Yval)") +
  theme_minimal()
```


## Multilogit regression for Mental Health

### Perceived Mental Health Status 

```{r}
filter_df <-small_df %>% select(MNHLTH31, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$MNHLTH31 <- relevel(filter_df$MNHLTH31, ref = "1 EXCELLENT")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(MNHLTH31 ~ AGELAST , data = filter_df, family = multinomial)

# summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) 
legend("topleft",legend = unique(filter_df$MNHLTH31), col = 1:5, lty = 1:5, lwd = 2)
```

```{r}
confint(fit)

null = vglm(MNHLTH31 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

```{r}
filter_df$mental = ordered(filter_df$MNHLTH31) 

# parallel = TRUE imposes proportional odds structure
# 2 intercepts for 3 y categories 
fit <-  vglm(mental ~ AGELAST + SDENICPROD,
             family = cumulative(parallel = TRUE),
             data = filter_df)

summary(fit)  # same effects for all 3 logits
```

```{r}
df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), SDENICPROD = "2 NO")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```

```{r}
null <-  vglm(mental ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(null)-deviance(fit),
df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

```{r}
fit2 <-  vglm(mental ~ SDENICPROD + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(fit)-deviance(fit2),
df=df.residual(fit)-df.residual(fit2), lower.tail=FALSE)


df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), SDENICPROD = "2 NO", SEX = "2 FEMALE")
preds = predict(fit2, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```



## General Health E-Smoking
```{r}
filter_df <-small_df %>% select(ADGENH42, SDENICPROD, SEX, AGELAST, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

# filter_df <- filter_df %>% filter(AGEGROUP == "65+")

filter_df$ADGENH42 <- relevel(filter_df$ADGENH42, ref = "1 EXCELLENT")
filter_df$SDENICPROD <- relevel(filter_df$SDENICPROD, ref = "2 NO")
filter_df$SEX <- relevel(filter_df$SEX, ref = "1 MALE")

fit <- vglm(ADGENH42 ~ AGELAST , data = filter_df, family = multinomial)

# summary(fit)

df_pred <- expand.grid(SEX = c("1 MALE", "2 FEMALE"), SDENICPROD = c("1 YES", "2 NO"), AGELAST = seq(18, 80))


matplot(df_pred$AGELAST, predict(fit, df_pred,type = "response"), type = "l",
        ylab = "Predicted Probability", xlab = "Age", lwd = 2) 
legend("topleft",legend = unique(filter_df$ADGENH42), col = 1:5, lty = 1:5, lwd = 2)
```

```{r}
confint(fit)

null = vglm(ADGENH42 ~ 1, family = multinomial, data  = filter_df)

print(pseudo_R2 <- 1 - deviance(fit) / deviance(null))

anova(fit, test="LRT")
```

```{r}
filter_df$mental = ordered(filter_df$ADGENH42) 

# parallel = TRUE imposes proportional odds structure
# 2 intercepts for 3 y categories 
fit <-  vglm(mental ~ AGELAST + SDENICPROD,
             family = cumulative(parallel = TRUE),
             data = filter_df)

summary(fit)  # same effects for all 3 logits
```

```{r}
df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), SDENICPROD = "2 NO")
preds = predict(fit, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```

```{r}
null <-  vglm(mental ~ 1,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(null)-deviance(fit),
df <- df.residual(null)-df.residual(fit), lower.tail=FALSE)
```

```{r}
fit2 <-  vglm(mental ~ SDENICPROD + SEX + AGELAST,
             family = cumulative(parallel = TRUE),
             data = filter_df)
pchisq(deviance(fit)-deviance(fit2),
df=df.residual(fit)-df.residual(fit2), lower.tail=FALSE)


df_pred = data.frame(AGELAST = seq(min(filter_df$AGELAST), max(filter_df$AGELAST), l = 50), SDENICPROD = "2 NO", SEX = "2 FEMALE", ADSMOK42 = "2 NO")
preds = predict(fit2, df_pred) # check that they sum to 1
cum_probabilities = t(apply(preds,1,plogis))

par(mfrow = c(1,2))
matplot(df_pred$AGELAST,cum_probabilities, lty = 1, type = "l", lwd = 2, 
        ylab = "Cumulative probabilites", xlab = "AGELAST") 
legend("bottomleft", 
       legend = gsub("link", "", colnames(cum_probabilities)), # remove link from labels
       col = c(1,2,3,4,5), lty = 1)
category_probabilities = t(apply(cbind(0,cum_probabilities,1),1,diff))
preds = predict(fit, df_pred, type = "response") # check that they are equivalent
matplot(df_pred$AGELAST, preds, lty = 1, type = "l", lwd = 2,
        ylab = "Category probabilites", xlab = "AGELAST")
legend("topright",
       legend = sprintf("Pr[Y = %g]", 1:5),
       col = c(1,2,3,4,5), lty = 1)
```

## Young Adults Aged 18-24 Who Had Ever Used an Electronic Nicotine have poor general health and more likely to have asthma diagnoses

```{r}
new_df <- small_df %>% select(ASTHDX, SDENICPROD, SEX, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

new_df <- new_df %>%  filter(AGEGROUP == "18-24")

new_df$ASTHDX <- relevel(new_df$ASTHDX, ref = "1 YES")
new_df$SDENICPROD <- relevel(new_df$SDENICPROD, ref = "2 NO")
new_df$SEX <- relevel(new_df$SEX, ref = "1 MALE")


fit <- glm(ASTHDX ~ SDENICPROD * SEX, data = new_df, family = "binomial")

summary(fit)

summ(fit, model.info = F)
```

```{r}
new_df <- small_df %>% select(ADGENH42, SDENICPROD, SEX, AGEGROUP) %>% filter(rowSums(sapply(., function(x) x %in% values_to_remove)) == 0)

new_df <- new_df %>%  filter(AGEGROUP == "18-24")

new_df$ADGENH42 <- relevel(new_df$ADGENH42, ref = "5 POOR")
new_df$SDENICPROD <- relevel(new_df$SDENICPROD, ref = "2 NO")
new_df$SEX <- relevel(new_df$SEX, ref = "1 MALE")


fit <- glm(ADGENH42 ~ SDENICPROD * SEX, data = new_df, family = "binomial")

summary(fit)

unique(small_df$ADGENH42)

summ(fit, model.info = F)
```





